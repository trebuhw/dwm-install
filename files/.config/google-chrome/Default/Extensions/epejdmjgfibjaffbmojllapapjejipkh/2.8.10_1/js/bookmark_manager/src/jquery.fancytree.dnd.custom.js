/*!
 * jquery.fancytree.dnd.js
 *
 * Drag-and-drop support (jQuery UI draggable/droppable).
 * (Extension module for jquery.fancytree.js: https://github.com/mar10/fancytree/)
 *
 * Copyright (c) 2008-2018, Martin Wendt (http://wwWendt.de)
 *
 * Released under the MIT license
 * https://github.com/mar10/fancytree/wiki/LicenseInfo
 *
 * @version @VERSION
 * @date @DATE
 */
!function(factory){"function"==typeof define&&define.amd?define(["jquery","jquery-ui/ui/widgets/draggable","jquery-ui/ui/widgets/droppable","./jquery.fancytree"],factory):"object"==typeof module&&module.exports?(require("./jquery.fancytree"),module.exports=factory(require("jquery"))):factory(jQuery)}((function($){"use strict";var didRegisterDnd=!1;function offsetString(n){return 0===n?"":n>0?"+"+n:""+n}function _initDragAndDrop(tree){var dnd=tree.options.dnd||null,glyph=tree.options.glyph||null;dnd&&(didRegisterDnd||($.ui.plugin.add("draggable","connectToFancytree",{start:function(event,ui){var draggable=$(this).data("ui-draggable")||$(this).data("draggable"),sourceNode=ui.helper.data("ftSourceNode")||null;if(sourceNode)return draggable.offset.click.top=-2,draggable.offset.click.left=16,sourceNode.tree.ext.dnd._onDragEvent("start",sourceNode,null,event,ui,draggable)},drag:function(event,ui){var ctx,draggable=$(this).data("ui-draggable")||$(this).data("draggable"),sourceNode=ui.helper.data("ftSourceNode")||null,prevTargetNode=ui.helper.data("ftTargetNode")||null,targetNode=$.ui.fancytree.getNode(event.target),dndOpts=sourceNode&&sourceNode.tree.options.dnd;event.target&&!targetNode&&$(event.target).closest("div.fancytree-drag-helper,#fancytree-drop-marker").length>0?(sourceNode||prevTargetNode||$.ui.fancytree).debug("Drag event over helper: ignored."):(ui.helper.data("ftTargetNode",targetNode),dndOpts&&dndOpts.updateHelper&&(ctx=sourceNode.tree._makeHookContext(sourceNode,event,{otherNode:targetNode,ui:ui,draggable:draggable,dropMarker:$("#fancytree-drop-marker")}),dndOpts.updateHelper.call(sourceNode.tree,sourceNode,ctx)),prevTargetNode&&prevTargetNode!==targetNode&&prevTargetNode.tree.ext.dnd._onDragEvent("leave",prevTargetNode,sourceNode,event,ui,draggable),targetNode&&targetNode.tree.options.dnd.dragDrop&&(targetNode===prevTargetNode||targetNode.tree.ext.dnd._onDragEvent("enter",targetNode,sourceNode,event,ui,draggable),targetNode.tree.ext.dnd._onDragEvent("over",targetNode,sourceNode,event,ui,draggable)))},stop:function(event,ui){var draggable=$(this).data("ui-draggable")||$(this).data("draggable"),sourceNode=ui.helper.data("ftSourceNode")||null,targetNode=ui.helper.data("ftTargetNode")||null,dropped="mouseup"===event.type&&1===event.which;dropped||(sourceNode||targetNode||$.ui.fancytree).debug("Drag was cancelled"),targetNode&&(dropped&&targetNode.tree.ext.dnd._onDragEvent("drop",targetNode,sourceNode,event,ui,draggable),targetNode.tree.ext.dnd._onDragEvent("leave",targetNode,sourceNode,event,ui,draggable)),sourceNode&&sourceNode.tree.ext.dnd._onDragEvent("stop",sourceNode,null,event,ui,draggable)}}),didRegisterDnd=!0)),dnd&&dnd.dragStart&&tree.widget.element.draggable($.extend({addClasses:!1,appendTo:tree.$container,containment:!1,delay:0,distance:4,revert:!1,scroll:!0,scrollSpeed:7,scrollSensitivity:10,connectToFancytree:!0,helper:function(event){var $helper,opts,sourceNode=$.ui.fancytree.getNode(event.target);return sourceNode?(opts=sourceNode.tree.options.dnd,$(sourceNode.span),($helper=$("<div class='fancytree-drag-helper'></div>").css({zIndex:3,position:"relative"})).data("ftSourceNode",sourceNode),glyph&&$helper.find(".fancytree-drag-helper-img").addClass(glyph.map._addClass+" "+glyph.map.dragHelper),opts.initHelper&&opts.initHelper.call(sourceNode.tree,sourceNode,{node:sourceNode,tree:sourceNode.tree,originalEvent:event,ui:{helper:$helper}}),$helper):"<div>ERROR?: helper requested but sourceNode not found</div>"},start:function(event,ui){return!!ui.helper.data("ftSourceNode")}},tree.options.dnd.draggable)),dnd&&dnd.dragDrop&&tree.widget.element.droppable($.extend({addClasses:!1,tolerance:"intersect",greedy:!1},tree.options.dnd.droppable))}return $.ui.fancytree.registerExtension({name:"dnd",version:"@VERSION",options:{autoExpandMS:1e3,draggable:null,droppable:null,focusOnClick:!1,preventVoidMoves:!0,preventRecursiveMoves:!0,smartRevert:!0,dropMarkerOffsetX:-24,dropMarkerInsertOffsetX:-16,dragStart:null,dragStop:null,initHelper:null,updateHelper:null,dragEnter:null,dragOver:null,dragExpand:null,dragDrop:null,dragLeave:null},treeInit:function(ctx){var tree=ctx.tree;this._superApply(arguments),tree.options.dnd.dragStart&&tree.$container.on("mousedown",(function(event){if(ctx.options.dnd.focusOnClick){var node=$.ui.fancytree.getNode(event);node&&node.debug("Re-enable focus that was prevented by jQuery UI draggable."),setTimeout((function(){$(event.target).closest(":tabbable").focus()}),10)}})),_initDragAndDrop(tree)},_setDndStatus:function(sourceNode,targetNode,helper,hitMode,accept){var markerOffsetX,pos,markerAt="center",instData=this._local,dndOpt=this.options.dnd,glyphOpt=this.options.glyph,$source=sourceNode?$(sourceNode.span):null,$target=$(targetNode.span),$targetTitle=$target.find("span.fancytree-title");if(instData.$dropMarker||(instData.$dropMarker=$("<div id='fancytree-drop-marker'></div>").hide().css({"z-index":1e3}).prependTo($(this.$div).parent()),glyphOpt&&instData.$dropMarker.addClass(glyphOpt.map._addClass+" "+glyphOpt.map.dropMarker)),"after"===hitMode||"before"===hitMode||"over"===hitMode){switch(markerOffsetX=dndOpt.dropMarkerOffsetX||0,hitMode){case"before":markerAt="top",markerOffsetX+=dndOpt.dropMarkerInsertOffsetX||0;break;case"after":markerAt="bottom",markerOffsetX+=dndOpt.dropMarkerInsertOffsetX||0}pos={my:"left"+offsetString(markerOffsetX)+" center",at:"left "+markerAt,of:$targetTitle},this.options.rtl&&(pos.my="right"+offsetString(-markerOffsetX)+" center",pos.at="right "+markerAt),instData.$dropMarker.toggleClass("fancytree-drop-after","after"===hitMode).toggleClass("fancytree-drop-over","over"===hitMode).toggleClass("fancytree-drop-before","before"===hitMode).toggleClass("fancytree-rtl",!!this.options.rtl).show().position($.ui.fancytree.fixPositionOptions(pos))}else instData.$dropMarker.hide();$source&&$source.toggleClass("fancytree-drop-accept",!0===accept).toggleClass("fancytree-drop-reject",!1===accept),$target.toggleClass("fancytree-drop-target","after"===hitMode||"before"===hitMode||"over"===hitMode).toggleClass("fancytree-drop-after","after"===hitMode).toggleClass("fancytree-drop-before","before"===hitMode).toggleClass("fancytree-drop-accept",!0===accept).toggleClass("fancytree-drop-reject",!1===accept),helper.toggleClass("fancytree-drop-accept",!0===accept).toggleClass("fancytree-drop-reject",!1===accept)},_onDragEvent:function(eventName,node,otherNode,event,ui,draggable){var accept,nodeOfs,parentRect,rect,relPos,relPos2,enterResponse,hitMode,r,dnd=this.options.dnd,ctx=this._makeHookContext(node,event,{otherNode:otherNode,ui:ui,draggable:draggable}),res=null,that=this,$nodeTag=$(node.span);switch(dnd.smartRevert&&(draggable.options.revert="invalid"),eventName){case"start":node.isStatusNode()?res=!1:dnd.dragStart&&(res=dnd.dragStart(node,ctx)),!1===res?(this.debug("tree.dragStart() cancelled"),ui.helper.trigger("mouseup").hide()):(dnd.smartRevert&&(rect=node[ctx.tree.nodeContainerAttrName].getBoundingClientRect(),parentRect=$(draggable.options.appendTo)[0].getBoundingClientRect(),draggable.originalPosition.left=Math.max(0,rect.left-parentRect.left),draggable.originalPosition.top=Math.max(0,rect.top-parentRect.top)),$nodeTag.addClass("fancytree-drag-source"),$(document).on("keydown.fancytree-dnd,mousedown.fancytree-dnd",(function(event){("keydown"===event.type&&event.which===$.ui.keyCode.ESCAPE||"mousedown"===event.type)&&that.ext.dnd._cancelDrag()})));break;case"enter":res=!!(r=(!dnd.preventRecursiveMoves||!node.isDescendantOf(otherNode))&&(dnd.dragEnter?dnd.dragEnter(node,ctx):null))&&($.isArray(r)?{over:$.inArray("over",r)>=0,before:$.inArray("before",r)>=0,after:$.inArray("after",r)>=0}:{over:!0===r||"over"===r,before:!0===r||"before"===r,after:!0===r||"after"===r}),ui.helper.data("enterResponse",res);break;case"over":if(hitMode=null,!1===(enterResponse=ui.helper.data("enterResponse")));else if("string"==typeof enterResponse)hitMode=enterResponse;else{nodeOfs=$nodeTag.offset();const CHROME_PAGE_ZOOM=Number((document.body.clientWidth/window.innerWidth).toFixed(2));relPos2={x:(relPos={x:event.pageX*CHROME_PAGE_ZOOM-nodeOfs.left,y:event.pageY*CHROME_PAGE_ZOOM-nodeOfs.top}).x/$nodeTag.width(),y:relPos.y/$nodeTag.height()},enterResponse.after&&relPos2.y>.75||!enterResponse.over&&enterResponse.after&&relPos2.y>.5?hitMode="after":enterResponse.before&&relPos2.y<=.25||!enterResponse.over&&enterResponse.before&&relPos2.y<=.5?hitMode="before":enterResponse.over&&(hitMode="over"),dnd.preventVoidMoves&&(node===otherNode?(this.debug("    drop over source node prevented"),hitMode=null):"before"===hitMode&&otherNode&&node===otherNode.getNextSibling()?(this.debug("    drop after source node prevented"),hitMode=null):"after"===hitMode&&otherNode&&node===otherNode.getPrevSibling()?(this.debug("    drop before source node prevented"),hitMode=null):"over"===hitMode&&otherNode&&otherNode.parent===node&&otherNode.isLastSibling()&&(this.debug("    drop last child over own parent prevented"),hitMode=null)),ui.helper.data("hitMode",hitMode)}"before"===hitMode||"after"===hitMode||!dnd.autoExpandMS||!1===node.hasChildren()||node.expanded||dnd.dragExpand&&!1===dnd.dragExpand(node,ctx)||node.scheduleAction("expand",dnd.autoExpandMS),hitMode&&dnd.dragOver&&(ctx.hitMode=hitMode,res=dnd.dragOver(node,ctx)),accept=!1!==res&&null!==hitMode,dnd.smartRevert&&(draggable.options.revert=!accept),this._local._setDndStatus(otherNode,node,ui.helper,hitMode,accept);break;case"drop":(hitMode=ui.helper.data("hitMode"))&&dnd.dragDrop&&(ctx.hitMode=hitMode,dnd.dragDrop(node,ctx));break;case"leave":node.scheduleAction("cancel"),ui.helper.data("enterResponse",null),ui.helper.data("hitMode",null),this._local._setDndStatus(otherNode,node,ui.helper,"out",void 0),dnd.dragLeave&&dnd.dragLeave(node,ctx);break;case"stop":$nodeTag.removeClass("fancytree-drag-source"),$(document).off(".fancytree-dnd"),dnd.dragStop&&dnd.dragStop(node,ctx);break;default:$.error("Unsupported drag event: "+eventName)}return res},_cancelDrag:function(){var dd=$.ui.ddmanager.current;dd&&dd.cancel()}}),$.ui.fancytree}));