function onFetchLoginMessage({win:win,tab:tab}){fetchLogin({win:win,tab:tab}).then((async({currentTabId:currentTabId,msg:msg,winId:winId})=>{chrome.windows.remove(winId),chrome.action.setPopup({popup:POPUP_URL}),chrome.action.setIcon({path:"assets/img/logo32x32.png"}),await storageLocalApi.setItem(IS_FIRST_OPEN,"true"),SamsungSCloudSyncService.SyncLogs.log("LOGIN_COMPLETE"),SamsungSCloudSyncService.SyncLogs.log(msg)})).catch((err=>{SamsungSCloudSyncService.SyncLogs.log(err),SamsungSCloudSyncService.SyncLogs.log("LOGIN_FAILURE")}))}function validateLogin(url){return console.log("validating login, url: ",url),new Promise((async(resolve,reject)=>{const params={};if(url.replace(/[?&]+([^=&]+)=([^&]*)/gi,((str,key,value)=>params[key]=value)),params.closedAction){const{closedAction:status,auth_server_url:auth_server_url,code:code}=params;if("signInSuccess"===status){const accountName=void 0===params.inputEmailID?params.inputPhoneID:decodeURIComponent(params.inputEmailID),tokens=await getAccessToken(code);await storageLocalApi.setArrayItems([[AUTH_URL,auth_server_url],[REFRESH_TOKEN,tokens.refresh_token],[REFRESH_TOKEN_EXPIRES_IN,tokens.refresh_token_expires_in],[ACCOUNT_NAME,accountName],[IS_LOGGED_OUT,1]]),getUserCountryCode(auth_server_url,tokens.userId,tokens.access_token),SamsungSCloudSyncService.SyncLogs.log("Refresh token received!"),await SamsungSCloudSyncService.BrowserOverlay.onAccessTokenReceived(url,tokens),resolve(status)}else reject(status)}}))}function getAccessToken(code){return new Promise(((resolve,reject)=>{const params=[`code=${code}`,`client_id=${APP_ID}`,`client_secret=${APP_SECRET}`,"grant_type=authorization_code"].join("&"),headers=new Headers;headers.append("Content-Type","application/x-www-form-urlencoded"),fetch(APIS.GET_AUTH_URL()+`?${params}`,{headers:headers,method:"POST"}).then((res=>{200!==res.status&&reject(res),resolve(res.json())}))}))}async function getAccountUrl(isFromChina,winId){const API_URL=APIS.LOGIN[isFromChina?"CN":"EU"],serviceID=APP_ID,{platform:platform}=navigator,ipAddress=storageLocalApi.getItem(CLIENT_IP)||"";getBrowserName().toLowerCase();let deviceID;const state=sha256([platform,getBrowserName(),EXT_DEVICE_ID,ipAddress,Date.now()].join("_")).slice(0,32),redirectUrl=REDIRECT_URL;storageLocalApi.getItem(DEVICE_UNIQUE_ID)?deviceID=storageLocalApi.getItem(DEVICE_UNIQUE_ID):(deviceID=sha256([platform,getBrowserName(),EXT_DEVICE_ID,ipAddress,Date.now()].join("_")).slice(0,39),storageLocalApi.setItem(DEVICE_UNIQUE_ID,deviceID));const loginurl=API_URL+[`redirect_uri=${redirectUrl}`,`client_id=${serviceID}`,"response_type=CODE",`state=${state}`].join("&");SamsungSCloudSyncService.SyncLogs.log("before load"),chrome.tabs.query({windowId:winId,active:!0},(([firstTab])=>chrome.tabs.update(firstTab.id,{url:loginurl})))}function fetchLogin({win:win,tab:tab}){return new Promise(((resolve,reject)=>{const currentTabId=win.tabs[0].id,winId=win.id,tabUpdateCallback=function(tabId,changeInfo,tab){var info;tab&&tab.url&&0===tab.url.indexOf(REDIRECT_URL)&&(info=tab,chrome.tabs.update(currentTabId,{url:chrome.runtime.getURL("login-load.html")}),validateLogin(info.url).then((msg=>resolve({msg:msg,currentTabId:currentTabId,winId:winId}))).catch(reject),chrome.tabs.onUpdated.removeListener(tabUpdateCallback))};isFromChina().then((result=>{getAccountUrl(result,winId),chrome.tabs.onUpdated.addListener(tabUpdateCallback)})),chrome.windows.onRemoved.addListener((id=>{if(winId==id&&chrome.tabs.onUpdated.hasListeners(tabUpdateCallback)&&chrome.tabs.onUpdated.removeListener(tabUpdateCallback),id===winId&&isLoggedIn()){var opt={type:"basic",iconUrl:"assets/img/logo48x48.png",title:"Samsung Internet",message:LOGIN_SUCCESS,priority:1};chrome.notifications.create("sortNotify",opt,(function(){})),setTimeout((function(){chrome.notifications.clear("sortNotify",(function(){}))}),3e3),SamsungSCloudSyncService.SyncLogs.log("Login popup closed.")}}))}))}function getUserCountryCode(auth_server_url,guid,token){const authUrl=auth_server_url||APIS.GET_AUTH_URL().replace("https://",""),_token=token||storageLocalApi.getItem(ACCESS_TOKEN),_guid=guid||storageLocalApi.getItem(USER_ID);fetch(`https://${authUrl}/v2/profile/user/user/${_guid}`,{headers:{Authorization:`Bearer ${_token}`,"x-osp-appId":APP_ID,"x-osp-userId":_guid}}).then((result=>result.text())).then((result=>{const countryIndex=result.indexOf("<countryCode>")+"<countryCode>".length,countryCode=result.substring(countryIndex,countryIndex+2);storageLocalApi.setItem("COUNTRY_CODE",countryCode)}))}