var treeSource=[],originChildren=null,deletedNode=null,originNode=null,selectedNodes=[],copyingNodes=[],cuttingNodes=[],originChildrenNodes=null,deleteTimeout=null,mainTreeContainer=null,viewState={previousScrollTopPosition:0,previousChosenFolderId:0,leftTreeScrollTop:0,reloadTree:!1},scrollInterval=null,scrollContent=null,scrollDownTrigger=null,scrollUpTrigger=null,isUpdateBookmarkPosition=!1;const scrollIntervalTime=16,scrollDistance=5;async function getUpdateDBTreeSource(){treeSource=await getDBTreeForManager()}mainTreeObj={};var mainTree=null,folderTree=null,expandDisabled=!1;function initMenuTree(){function clearScrollInterval(){clearInterval(scrollInterval),scrollInterval=null}function loadBookmarkMenuItem(node){var items,deleteDisable,disable=disabledItem(node);if(storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED&&(deleteDisable=!0),1==node.folder&&node.data.id<0)items={delete:{name:CONTEXT_DELETE,icon:"icon",disabled:deleteDisable,callback:function(itemKey,opt,e){var node=$.ui.fancytree.getNode(opt.$trigger),id=node.data.id,title=node.title,url=node.data.url;deletedNode=$.extend({},node),removeBookmark_fancytree({e:e,id:id,title:title,isFolder:!0,url:url}),refreshMainTreeContent(node.data.parent.data.id)}},AddNewFolder:{name:POPUP_ADD_NEW_FOLDER,icon:"folder",callback:function(itemKey,opt,e){dialogAddNewFolder(originNode)}}};else if(1!=node.folder){disable=!1;storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED&&(disable=!0),items={open:{name:OPEN,icon:"open",callback:function(itemKey,opt,e){var url=(MenuContentView.isOpenEditBar?selectedNodes[0]:$.ui.fancytree.getNode(opt.$trigger)).data.url;openUrl([url],"OPEN")}},openInNewTab:{name:CONTEXT_OPEN_NEW_TAB,icon:"open",callback:function(itemKey,opt,e){var url=(MenuContentView.isOpenEditBar?selectedNodes[0]:$.ui.fancytree.getNode(opt.$trigger)).data.url;openUrl([url],"OPEN_NEW_TAB")}},openInNewWindow:{name:CONTEXT_OPEN_NEW_WINDOW,icon:"open",callback:function(itemKey,opt,e){var url=(MenuContentView.isOpenEditBar?selectedNodes[0]:$.ui.fancytree.getNode(opt.$trigger)).data.url;openUrl([url],"OPEN_NEW_WINDOW")}},openInSecretWindow:{name:CONTEXT_OPEN_IN_INCOGNITO_WINDOW,icon:"open",callback:function(itemKey,opt,e){var url=(MenuContentView.isOpenEditBar?selectedNodes[0]:$.ui.fancytree.getNode(opt.$trigger)).data.url;openUrl([url],"OPEN_NEW_SECRET_WINDOW")}},sep1:"--"};let bottomItems={move:{name:CONTEXT_MOVE,icon:"icon",disabled:disable,callback:function(key,opt){var node=MenuContentView.isOpenEditBar?selectedNodes[0]:$.ui.fancytree.getNode(opt.$trigger);selectedNodes=[node],dialogMoveBookmark(node)}},edit:{name:CONTEXT_EDIT,icon:"icon",disabled:disable,callback:function(key,opt){dialogEditBookmark(MenuContentView.isOpenEditBar?selectedNodes[0]:$.ui.fancytree.getNode(opt.$trigger))}},copy:{name:CONTEXT_COPY,icon:"icon",disabled:disable,callback:function(itemKey,opt,e){selectedNodes=[node],copySelectedNodes()}}},deleteItem={};MenuContentView.isOpenEditBar||(deleteItem.delete={name:CONTEXT_DELETE,icon:"icon",disabled:disable||!!deleteTimeout,callback:function(itemKey,opt,e){deleteBookmarkOrTab($.ui.fancytree.getNode(opt.$trigger))}}),items=Object.assign({},items,deleteItem,bottomItems)}else{var openAllBookmarksDisable,onSyncing=!1;storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED&&(onSyncing=!0),openAllBookmarksDisable=onSyncing||disabledItem(node),items={openInNewTab:{name:CONTEXT_OPEN_NEW_TAB,icon:"open",disabled:openAllBookmarksDisable,callback:function(itemKey,opt,e){var urls=getAllChildrenURL(opt);openUrl([urls],"OPEN_ALL_BOOKMARKS")}},openInNewWindow:{name:CONTEXT_OPEN_NEW_WINDOW,icon:"open",disabled:openAllBookmarksDisable,callback:function(itemKey,opt,e){var urls=getAllChildrenURL(opt);openUrl([urls],"OPEN_ALL_NEW_WINDOW")}},openAllInSecretWindow:{name:CONTEXT_OPEN_IN_INCOGNITO_WINDOW,icon:"open",disabled:openAllBookmarksDisable,callback:function(itemKey,opt,e){var urls=getAllChildrenURL(opt);openUrl([urls],"OPEN_ALL_NEW_SECRET_WINDOW")}},sep1:"--"};let bottomItems={move:{name:CONTEXT_MOVE,icon:"icon",disabled:onSyncing,callback:function(key,opt){var node=MenuContentView.isOpenEditBar?selectedNodes[0]:$.ui.fancytree.getNode(opt.$trigger);selectedNodes=[node],dialogMoveBookmark(node)}},edit:{name:CONTEXT_EDIT,icon:"icon",disabled:onSyncing,callback:function(key,opt){dialogEditBookmark(MenuContentView.isOpenEditBar?selectedNodes[0]:$.ui.fancytree.getNode(opt.$trigger))}}},deleteItem={};MenuContentView.isOpenEditBar||(deleteItem.delete={name:CONTEXT_DELETE,icon:"icon",disabled:onSyncing||!!deleteTimeout,callback:function(itemKey,opt,e){deleteBookmarkOrTab($.ui.fancytree.getNode(opt.$trigger))}}),items=Object.assign({},items,deleteItem,bottomItems)}return items}function loadTabMenuItem(node){var disable,items,deleteDisable;return storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED&&(deleteDisable=!0),1==node.folder?(disable=disabledItem(node),items={openAllTabs:{name:CONTEXT_OPEN_ALL,icon:"open",disabled:disable,callback:function(itemKey,opt,e){var urls=getAllChildrenURL(opt);openUrl([urls],"OPEN_ALL_BOOKMARKS")}},deleteAll:{name:CONTEXT_DELETE_ALL+"(D)",icon:"icon",disabled:deleteDisable,callback:function(itemKey,opt,e){var node=$.ui.fancytree.getNode(opt.$trigger),id=node.data.id,title=node.title,url=node.data.url;deletedNode=$.extend({},node),removeTab_fancytree({e:e,id:id,title:title,isFolder:!0,url:url}),folderTree.getNodeByKey(node.key).remove(),originNode=null,refreshMainTreeContent(node.data.parent.data.id)}}}):(storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED&&(disable=!0),items={open:{name:OPEN,icon:"open",callback:function(itemKey,opt,e){var url=$.ui.fancytree.getNode(opt.$trigger).data.url;openUrl([url],"OPEN")}},openInNewTab:{name:CONTEXT_OPEN_NEW_TAB,icon:"open",callback:function(itemKey,opt,e){var url=$.ui.fancytree.getNode(opt.$trigger).data.url;openUrl([url],"OPEN_NEW_TAB")}},openInNewWindow:{name:CONTEXT_OPEN_NEW_WINDOW,icon:"open",callback:function(itemKey,opt,e){var url=$.ui.fancytree.getNode(opt.$trigger).data.url;openUrl([url],"OPEN_NEW_WINDOW")}},sep1:"--",delete:{name:CONTEXT_DELETE,icon:"icon",disabled:disable,callback:function(itemKey,opt,e){var node=$.ui.fancytree.getNode(opt.$trigger),id=node.data.id,title=node.title,parentId=node.data.parent.data.id,url=node.data.url;deletedNode=$.extend({},node),removeTab_fancytree({e:e,id:id,title:title,isFolder:!1,parent:parentId,url:url}),folderTree.getNodeByKey(node.key).remove(),updateSourcePosition(node.data.parent.children),node.data.parent.children?refreshMainTreeContent(parentId):originNode=null}}}),items}function loadMultiSelectionMenu(){var openAllBookmarksDisable,onSyncing=!1,urls=getAllURLSelected();if(storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED&&(onSyncing=!0),openAllBookmarksDisable=onSyncing||!urls.length,hasSelectedFolder()){items={openInNewTab:{name:CONTEXT_OPEN_NEW_TAB,icon:"open",disabled:openAllBookmarksDisable,callback:function(itemKey,opt,e){openUrl([urls],"OPEN_ALL_BOOKMARKS")}},openInNewWindow:{name:CONTEXT_OPEN_NEW_WINDOW,icon:"open",disabled:openAllBookmarksDisable,callback:function(itemKey,opt,e){openUrl([urls],"OPEN_ALL_NEW_WINDOW")}},openAllInSecretWindow:{name:CONTEXT_OPEN_IN_INCOGNITO_WINDOW,icon:"open",disabled:openAllBookmarksDisable,callback:function(itemKey,opt,e){openUrl([urls],"OPEN_ALL_NEW_SECRET_WINDOW")}},sep1:"--"};let bottomItems={move:{name:CONTEXT_MOVE,icon:"icon",disabled:onSyncing,callback:function(key,opt){dialogMoveBookmark(MenuContentView.isOpenEditBar?selectedNodes[0]:$.ui.fancytree.getNode(opt.$trigger))}}},deleteItem={};MenuContentView.isOpenEditBar||(deleteItem.delete={name:CONTEXT_DELETE,icon:"icon",disabled:onSyncing||!!deleteTimeout,callback:function(itemKey,opt,e){var node=$.ui.fancytree.getNode(opt.$trigger);deleteMultiBookmarkOrTab(node)}}),items=Object.assign({},items,deleteItem,bottomItems)}else{items={openInNewTab:{name:CONTEXT_OPEN_NEW_TAB,icon:"open",disabled:onSyncing,callback:function(itemKey,opt,e){openUrl([urls],"OPEN_ALL_BOOKMARKS")}},openInNewWindow:{name:CONTEXT_OPEN_NEW_WINDOW,icon:"open",disabled:onSyncing,callback:function(itemKey,opt,e){openUrl([urls],"OPEN_ALL_NEW_WINDOW")}},openAllInSecretWindow:{name:CONTEXT_OPEN_IN_INCOGNITO_WINDOW,icon:"open",disabled:onSyncing,callback:function(itemKey,opt,e){openUrl([urls],"OPEN_ALL_NEW_SECRET_WINDOW")}},sep1:"--"};let bottomItems={move:{name:CONTEXT_MOVE,icon:"icon",disabled:onSyncing,callback:function(key,opt){dialogMoveBookmark(MenuContentView.isOpenEditBar?selectedNodes[0]:$.ui.fancytree.getNode(opt.$trigger))}},copy:{name:CONTEXT_COPY,icon:"icon",disabled:onSyncing,callback:function(itemKey,opt,e){copySelectedNodes()}}},deleteItem={};MenuContentView.isOpenEditBar||(deleteItem.delete={name:CONTEXT_DELETE,icon:"icon",disabled:onSyncing||!!deleteTimeout,callback:function(itemKey,opt,e){var node=$.ui.fancytree.getNode(opt.$trigger);deleteMultiBookmarkOrTab(node)}}),items=Object.assign({},items,deleteItem,bottomItems)}return items}function loadMultiSelectionTabMenu(){var disable=!1;return storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED&&(disable=!0),items={delete:{name:CONTEXT_DELETE,icon:"icon",disabled:disable,callback:function(itemKey,opt,e){var node=$.ui.fancytree.getNode(opt.$trigger);deleteMultiBookmarkOrTab(node)}}},items}function loadContextEditMode($trigger){var node=selectedNodes[0];return selectedNodes.length>1?"bookmark"==node.type?loadMultiSelectionMenu():loadMultiSelectionTabMenu():"bookmark"==node.type?loadBookmarkMenuItem(node):loadTabMenuItem(node)}function loadItems($trigger,moreOption=!1){var node=$.ui.fancytree.getNode($trigger);return node.span.className.indexOf("fancytree-selected")>=0&&selectedNodes.length>1?"bookmark"==node.type?loadMultiSelectionMenu():loadMultiSelectionTabMenu():(null!=node&&node.span.className.indexOf("fancytree-selected")<0&&(selectedNodes=[],mainTree.selectAll(!1),node.setActive(),MenuContentView.isOpenEditBar&&node.setSelected(!0)),"bookmark"==node.type?loadBookmarkMenuItem(node):loadTabMenuItem(node))}function dialogAddNewFolder(node){var parentNode=node;CreateModal.parentFolder=parentNode,CreateModal.folder.parentTitle=parentNode.title,CreateModal.folder.parent=parentNode.data.id,CreateModal.visible=!0}mainTreeObj={mainTreeInit:async function(data){getViewState(),null==mainTree&&($("#mainContent").fancytree({extensions:["themeroller","dnd","multi"],source:[],toggleEffect:!1,multi:{mode:"sameParent"},dnd:{preventVoidMoves:!0,preventRecursiveMoves:!0,autoExpandMS:!1,draggable:{zIndex:1e3,scroll:!1,containment:"parent",revert:"invalid",appendTo:"body"},multiSource:!0,initHelper:function(node,data){var helper=data.ui.helper,sourceNodes=data.tree.getSelectedNodes();node.isSelected()||sourceNodes.unshift(node),helper.data("sourceNodes",sourceNodes),$(".fancytree-active,.fancytree-selected",mainTree.$container).addClass("fancytree-drag-source"),helper.append($("<span class='fancytree-childcounter'/>").text(sourceNodes.length));var customHelper=document.createElement("div");customHelper.className="fancytree-drag-helper fancytree-drag-helper-custom ui-draggable-dragging",$("<span class='fancytree-childcounter'/>").clone().text(sourceNodes.length).appendTo(customHelper),document.body.append(customHelper)},updateHelper:function(node,data){var event=data.originalEvent,tree=node.tree,copyMode=event.ctrlKey||event.altKey;const CHROME_PAGE_ZOOM=Number((document.body.clientWidth/window.innerWidth).toFixed(2));var childCountPosition={top:data.ui.helper[0].offsetTop*CHROME_PAGE_ZOOM,left:data.ui.helper[0].offsetLeft*CHROME_PAGE_ZOOM};$(".fancytree-drag-helper-custom").css({position:"absolute","z-index":1e3}),$(".fancytree-drag-helper-custom").offset(childCountPosition),data.ui.helper.find(".fancytree-dnd-modifier").toggle(copyMode),$(".fancytree-drag-source",tree.$container).toggleClass("fancytree-drag-remove",!copyMode)},dragStart:function(node,data){return"tab"!==node.type&&storageLocalApi.getItem(SYNC_STATUS)!=SYNC_STARTED},dragEnter:function(node,data){return scrollInterval&&scrollContent&&"menuTree"===scrollContent.id&&clearScrollInterval(),"tab"!==node.type},dragOver:function(node,data){const dndMarker=document.querySelector("#menu-content #fancytree-drop-marker");dndMarker&&(data.node.folder&&"over"===data.hitMode?dndMarker.style.visibility="visible":dndMarker.style.visibility="hidden");const CHROME_PAGE_ZOOM=Number((document.body.clientWidth/window.innerWidth).toFixed(2));scrollContent=document.getElementById("menu-content"),scrollDownTrigger=window.innerHeight-40/CHROME_PAGE_ZOOM,scrollUpTrigger=window.innerHeight-scrollContent.offsetHeight/CHROME_PAGE_ZOOM+10,data.originalEvent.clientY>scrollDownTrigger?scrollInterval||(scrollInterval=setInterval((()=>{scrollContent.scroll({top:scrollContent.scrollTop+5})}),16)):data.originalEvent.clientY<scrollUpTrigger?scrollInterval||(scrollInterval=setInterval((()=>{scrollContent.scroll({top:scrollContent.scrollTop-5})}),16)):clearScrollInterval()},dragStop:function(node,data){expandDisabled=!1,$(".fancytree-drag-helper-custom")&&$(".fancytree-drag-helper-custom").remove(),scrollInterval&&clearScrollInterval();var sourceNodes=data.ui.helper.data("sourceNodes");sourceNodes&&sourceNodes.length&&sourceNodes.forEach((node=>{node.span.classList.remove("fancytree-drag-source","fancytree-drag-remove")}))},dragDrop:function(node,data){if(isUpdateBookmarkPosition=!0,storageLocalApi.getItem(SYNC_STATUS)!=SYNC_STARTED&&0!==node.folder&&"over"===data.hitMode&&"tab"!==node.type){var sourceNodes=data.ui.helper.data("sourceNodes"),isCrossTree=!1;sourceNodes[0].tree!=data.tree?(isCrossTree=!0,$.each(sourceNodes,(function(i,o){folderTree.getNodeByKey(o.key).data.parent=node.data.id,folderTree.getNodeByKey(o.key).moveTo(folderTree.getNodeByKey(node.key),data.hitMode)}))):$.each(sourceNodes,(function(i,o){"over"===data.hitMode&&(folderTree.getNodeByKey(o.key).data.parent=node.data.id),folderTree.getNodeByKey(o.key).moveTo(folderTree.getNodeByKey(node.key),data.hitMode)}));var children=null;children=isCrossTree?folderTree.getNodeByKey(data.otherNode.parent.key).parent.children:"over"===data.hitMode?folderTree.getNodeByKey(node.key).children:folderTree.getNodeByKey(node.key).parent.children,isCrossTree&&(children=folderTree.getNodeByKey(node.key).parent.children),updateSourcePosition(children),refreshMainTreeContent(originNode.data.id)}}},beforeExpand:function(event,data){if(data.originalEvent)return!1},tooltip:function(event,data){return data.node.title},renderNode:function(event,data){let node=data.node;var $span=$(node.span),$li=$(node.li),checkBox=document.createElement("span");if(checkBox.className="checkBox",$li[0].prepend(checkBox),$span&&(!$span.find("span.reorderIcon")||0===$span.find("span.reorderIcon").length)){const reorder=document.createElement("span");reorder.className="reorderIcon",$span[0].append(reorder)}if(1==node.folder)return;$span.find("span.fancytree-expander").remove(),$span.find("img.fancytree-more-option").remove();var href=node.data.url,faviconURL=`${h("a",{href:href}).origin}/favicon.ico`;const initial=url2title(faviconURL).substr(0,1).toUpperCase();var iconSpan=$span.find("> span.fancytree-icon")[0];iconSpan.style.backgroundColor="#BABABA";var text=document.createElement("span");text.className="thumbnail",iconSpan.appendChild(text),$span.find("> span.fancytree-icon").find("> span.thumbnail")[0].innerHTML=initial,iconSpan.appendChild(h("img",{class:"bookmark_entry_image",style:"display: none;",load(e){iconSpan.style.backgroundColor="",iconSpan.querySelector("span").remove(),this.style.display="block"},src:faviconURL}))},dblclick:function(e,data){return!MenuContentView.isOpenEditBar&&(1==data.node.folder?(MenuContentView.viewFolder=data.node,MenuContentView.stackNodes.push(originNode),refreshMainTreeContent((originNode=data.node).data.id),MenuContentView.isSearchEnabled&&MenuContentView.closeSearching(),!1):void openUrl([data.node.data.url],"OPEN_NEW_TAB"))},click:function(e,data){if(data.node.span.classList.contains("fancytree-drag-source"))return!1;if(MenuContentView.isOpenEditBar)e.ctrlKey||e.shiftKey?e.ctrlKey&&data.node.setActive(!data.node.selected):(data.node.setSelected(!data.node.selected),data.node.setFocus(!1),data.node.setActive(data.node.selected),e.preventDefault());else if(e.ctrlKey||e.shiftKey)e.ctrlKey?data.node.setActive(!data.node.selected):e.shiftKey&&!MenuContentView.isOpenEditBar&&MenuContentView.toggleEditBar(!0);else{if(1==data.node.folder)return MenuContentView.viewFolder=data.node,MenuContentView.stackNodes.push(originNode),refreshMainTreeContent((originNode=data.node).data.id),MenuContentView.isSearchEnabled&&MenuContentView.closeSearching(),!1;openUrl([data.node.data.url],"OPEN_NEW_TAB")}},keydown:function(event,data){if(disableMovingSelectedNode(event))return!1},select:function(event,data){selectedNodes=data.tree.getSelectedNodes(),MenuContentView.isOpenEditBar&&storageLocalApi.getItem(SYNC_STATUS)!=SYNC_STARTED&&MenuContentView.onChangeSelectedNodes()}}),mainTree=$("#mainContent").fancytree("getTree"),$("#mainContent > ul").sortable({axis:"y",scroll:!1,handle:".reorderIcon.editing",sort:function(event,ui){!function(data,ui){const CHROME_PAGE_ZOOM=Number((document.body.clientWidth/window.innerWidth).toFixed(2));scrollContent=document.getElementById("menu-content"),scrollDownTrigger=window.innerHeight-40/CHROME_PAGE_ZOOM,scrollUpTrigger=window.innerHeight-scrollContent.offsetHeight/CHROME_PAGE_ZOOM+10,scrollContent.clientHeight<scrollContent.scrollHeight&&data.originalEvent.clientY>scrollDownTrigger?(ui.helper&&ui.helper[0]&&ui.helper[0].classList.add("onBottom"),scrollInterval||(scrollInterval=setInterval((()=>{scrollContent.scroll({top:scrollContent.scrollTop+5})}),16))):scrollContent.clientHeight<scrollContent.scrollHeight&&data.originalEvent.clientY<scrollUpTrigger?(ui.helper&&ui.helper[0]&&(ui.helper[0].classList.add("onTop"),$(".ui-sortable-helper.onTop").css({top:(document.querySelector(".sync-content").clientHeight-document.getElementById("menu-content").clientHeight)/CHROME_PAGE_ZOOM+"px"})),scrollInterval||(scrollInterval=setInterval((()=>{scrollContent.scroll({top:scrollContent.scrollTop-5})}),16))):(ui.helper&&ui.helper[0]&&(ui.helper[0].classList.remove("onBottom"),ui.helper[0].classList.remove("onTop")),scrollInterval&&clearScrollInterval())}(event,ui)},stop:function(event,ui){scrollInterval&&clearScrollInterval(),ui.item&&ui.item[0]&&(ui.item[0].classList.remove("onBottom"),ui.item[0].classList.remove("onTop"));const rootNode=mainTree.getRootNode();if(rootNode&&rootNode.ul){let childNodes=[];(rootNode.ul.childNodes||[]).forEach((child=>{child.ftnode&&childNodes.push(child.ftnode)})),isUpdateBookmarkPosition=!0,updateSourcePosition(childNodes)}}})),mainTree.clear(),clearSelectedNodes(),data.node.children&&mainTree.reload(data.node.children),MenuContentView.toggleEditBar(MenuContentView.isOpenEditBar),originNode&&(!function(node){const activeNode=getNodeById(node.data.id),menuTreeElement=document.getElementById("menuTree");if(activeNode&&activeNode.span&&activeNode.span.offsetHeight){const position=activeNode.span.offsetTop>viewState.leftTreeScrollTop?viewState.leftTreeScrollTop:activeNode.span.offsetTop;folderTree.activateKey(activeNode.key),menuTreeElement.scrollTop=position}}(originNode),await storageLocalApi.setItem("ORIGIN_ID",originNode.data.id)),mainTreeContainer.scrollTop=viewState.previousScrollTopPosition,$("#menuTree").fancytree("getTree").filterNodes((function(node){return!!node.folder}))}},$("#menuTree").fancytree({extensions:["themeroller","filter","dnd"],source:treeSource,toggleEffect:!1,filter:{mode:"hide"},dnd:{preventVoidMoves:!0,preventRecursiveMoves:!0,autoExpandMS:400,multiSource:!0,draggable:{zIndex:1e3,scroll:!1,containment:"parent",revert:"invalid"},initHelper:function(node,data){var helper=data.ui.helper,sourceNodes=data.tree.getSelectedNodes();node.isSelected()||sourceNodes.unshift(node),helper.data("sourceNodes",sourceNodes),$(".fancytree-active,.fancytree-selected",mainTree.$container).addClass("fancytree-drag-source"),sourceNodes.length>1&&helper.append($("<span class='fancytree-childcounter'/>").text(sourceNodes.length))},updateHelper:function(node,data){var event=data.originalEvent,tree=node.tree,copyMode=event.ctrlKey||event.altKey;data.ui.helper.find(".fancytree-dnd-modifier").toggle(copyMode),$(".fancytree-drag-source",tree.$container).toggleClass("fancytree-drag-remove",!copyMode)},dragStart:function(node,data){return!1},dragEnter:function(node,data){let disabledIds=[];return expandDisabled=!1,scrollInterval&&scrollContent&&"menu-content"===scrollContent.id&&clearScrollInterval(),!(node.data.id<0&&node.data.id!=IMPORTED_FOLDER_IDS.SBROWSER||"tab"===node.type)&&(selectedNodes&&selectedNodes.length?selectedNodes.forEach((node=>{node.folder&&(disabledIds.push(node.data.id),node.visit((function(child){disabledIds.push(child.data.id)})))})):data.otherNode&&data.otherNode.folder&&(disabledIds.push(data.otherNode.data.id),data.otherNode.visit((function(child){disabledIds.push(child.data.id)}))),!disabledIds.includes(node.data.id)||(expandDisabled=!0,!1))},dragOver:function(node,data){const dndMarker=document.querySelector("#menuTreeDiv #fancytree-drop-marker");dndMarker&&("over"===data.hitMode?dndMarker.style.visibility="visible":dndMarker.style.visibility="hidden");const CHROME_PAGE_ZOOM=Number((document.body.clientWidth/window.innerWidth).toFixed(2)),headerExt=document.querySelector(".side-header .header-item");scrollContent=document.getElementById("menuTree"),scrollDownTrigger=(scrollContent.offsetHeight+headerExt.offsetHeight-20)/CHROME_PAGE_ZOOM,scrollUpTrigger=(headerExt.offsetHeight+20)/CHROME_PAGE_ZOOM,data.originalEvent.clientY>scrollDownTrigger?scrollInterval||(scrollInterval=setInterval((()=>{scrollContent.scroll({top:scrollContent.scrollTop+5})}),16)):data.originalEvent.clientY<scrollUpTrigger?scrollInterval||(scrollInterval=setInterval((()=>{scrollContent.scroll({top:scrollContent.scrollTop-5})}),16)):clearScrollInterval()},dragStop:function(node,data){expandDisabled=!1},dragDrop:function(node,data){if(isUpdateBookmarkPosition=!0,storageLocalApi.getItem(SYNC_STATUS)!=SYNC_STARTED&&"over"===data.hitMode&&"tab"!==node.type){var sourceNodes=data.ui.helper.data("sourceNodes"),isCrossTree=!1,parentKey=null;sourceNodes[0].tree!=data.tree?(isCrossTree=!0,parentKey=folderTree.getNodeByKey(data.otherNode.key).parent.key,$.each(sourceNodes,(function(i,o){folderTree.getNodeByKey(o.key).data.parent=node.data.id,folderTree.getNodeByKey(o.key).moveTo(folderTree.getNodeByKey(node.key),data.hitMode)}))):$.each(sourceNodes,(function(i,o){"over"===data.hitMode&&(folderTree.getNodeByKey(o.key).data.parent=node.data.id),folderTree.getNodeByKey(o.key).moveTo(folderTree.getNodeByKey(node.key),data.hitMode)}));var children=null;children=isCrossTree?folderTree.getNodeByKey(data.otherNode.key).parent.children:"over"===data.hitMode?folderTree.getNodeByKey(node.key).children:folderTree.getNodeByKey(node.key).parent.children,$("#menuTree").fancytree("getTree").filterNodes((function(node){return 1===node.folder})),updateSourcePosition(children),isCrossTree&&updateSourcePosition(children=folderTree.getNodeByKey(parentKey).children),viewNode(getNodeById(originNode.data.id))}}},beforeExpand:function(event,data){if(expandDisabled)return!1},select:function(e,data){},activate:function(e,data){storageLocalApi.setItem("LEFT_PANE_ACTIVE",data.node.data.id);var $span=$(data.node.span);data.node.data.id==IMPORTED_FOLDER_IDS[getBrowserName().toUpperCase()]&&MenuContentView.chromeBookmarkBadge&&$span.find(".chromeBadge")&&(MenuContentView.chromeBookmarkBadge="",$span.find(".chromeBadge").remove())},click:function(e,data){if(data.node.data.id===IMPORTED_MAIN_FOLDER_IDS.BOOKMARKS||data.node.data.id===IMPORTED_MAIN_FOLDER_IDS.TABS)return data.node.toggleExpanded(),!1;MenuContentView.onSetting&&(ContentSettings.closeSettingsView(),window.CredentialHome&&CredentialHome.close()),MenuContentView.isSearchEnabled&&MenuContentView.closeSearching(),data.originalEvent.target&&data.originalEvent.target.className.indexOf("fancytree-expander")>=0&&e.preventDefault(),data.node.toggleExpanded(),originNode&&originNode.data.id==data.node.data.id||(MenuContentView.stackNodes=[],MenuContentView.viewFolder=data.node,refreshMainTreeContent((originNode=data.node).data.id))},dblclick:function(e,data){if(data.node.data.id!==IMPORTED_MAIN_FOLDER_IDS.BOOKMARKS&&data.node.data.id!==IMPORTED_MAIN_FOLDER_IDS.TABS)return!1},keydown:function(event,data){if(disableMovingSelectedNode(event))return!1},tooltip:function(event,data){return data.node.title},renderNode:function(e,data){for(var p=data.node.parent,$span=$(data.node.span);null!=p&&p.data.id!=IMPORTED_FOLDER_IDS.CHROME&&data.node.data.id!=IMPORTED_FOLDER_IDS.CHROME&&p.data.parent!=IMPORTED_FOLDER_IDS.CHROME;)p=p.parent,$span.find(".fancytree-icon").addClass("samsung-bookmarks");data.node.li.classList.add("level-"+data.node.getLevel()),data.node.data.id!=IMPORTED_FOLDER_IDS[getBrowserName().toUpperCase()]||!MenuContentView.chromeBookmarkBadge||$span.find(".chromeBadge")&&0!==$span.find(".chromeBadge").length||$span[0].appendChild(h("img",{class:"chromeBadge",src:MenuContentView.chromeBookmarkBadge}))},init:function(e,data){(folderTree=$("#menuTree").fancytree("getTree")).rootNode.children[0].setExpanded(!0);const originId=storageLocalApi.getItem("ORIGIN_ID");if(!(originNode=getNodeById(originId))||storageLocalApi.getItem("IS_SYNC_NOW"))(originNode=folderTree.rootNode.children[0].children[0]).setActive(),storageLocalApi.setItem("IS_SYNC_NOW",!1);else{const leftPaneId=storageLocalApi.getItem("LEFT_PANE_ACTIVE");(leftPaneId?getNodeById(leftPaneId):folderTree.rootNode.children[0].children[0]).setActive()}MenuContentView.viewFolder=originNode,viewState.reloadTree=!0,refreshMainTreeContent(originNode.data.id)}}),folderTree.filterNodes((function(node){return 0!==node.folder})),$.contextMenu({selector:"span.fancytree-title, img.bookmark_entry_image, span.thumbnail, span.fancytree-node",build:function($trigger,e){var node=$.ui.fancytree.getNode($trigger);return!([IMPORTED_MAIN_FOLDER_IDS.BOOKMARKS,IMPORTED_MAIN_FOLDER_IDS.TABS,IMPORTED_FOLDER_IDS.SBROWSER,IMPORTED_FOLDER_IDS.CHROME,IMPORTED_FOLDER_IDS.EDGE,IMPORTED_FOLDER_IDS.OPERA].indexOf(node.data.id)>=0||MenuContentView.searchResultsEnabled||MenuContentView.isOpenEditBar)&&{callback:function(key,options){},items:loadItems($trigger)}}}),$.contextMenu({selector:"#moreMenuEditMode",trigger:"left",build:function($trigger,e){return{callback:function(key,options){},items:loadContextEditMode()}}}),$.contextMenu({selector:"#more-options",trigger:"left",build:function($trigger,e){let onSyncing=!1;return storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED&&(onSyncing=!0),{callback:function(key,options){},items:{edit:{name:CONTEXT_EDIT,icon:"icon",disabled:onSyncing,callback:function(key,opt){MenuContentView.toggleEditBar(!0)}},AddNewFolder:{name:CREATE_NEW_FOLDER,icon:"folder",disabled:onSyncing,callback:function(itemKey,opt,e){dialogAddNewFolder(originNode)}}}}}})}function getViewState(){mainTreeContainer=document.getElementById("menu-content"),viewState.previousChosenFolderId!==MenuContentView.viewFolder.data.id?(viewState.previousScrollTopPosition=0,viewState.previousChosenFolderId=MenuContentView.viewFolder.data.id):viewState.previousScrollTopPosition=mainTreeContainer.scrollTop,viewState.reloadTree||(viewState.leftTreeScrollTop=document.getElementById("menuTree").scrollTop),viewState.reloadTree=!1}function clearSelectedNodes(){selectedNodes=[],MenuContentView.searchResultsEnabled?MenuContentView.onChangeSelectedSearchItems():MenuContentView.onChangeSelectedNodes()}function dialogEditBookmark(node){const target={dataset:{id:node.data.id,title:node.title,parentId:node?getParentId(node):"0",url:node.data.url,isFolder:1===node.folder&&"true",targetNode:node}};onEditClick({},target)}function dialogMoveBookmark(node){MoveModal.parent.id=node?getParentId(node):0,MoveModal.selectedBookmarks=selectedNodes,MoveModal.toggle()}function getAllChildrenURL(opt){var node=MenuContentView.isOpenEditBar||MenuContentView.onEditSearchResults?getNodeById(selectedNodes[0].data.id):getNodeById($.ui.fancytree.getNode(opt.$trigger).data.id),urls=[];if(node.hasChildren())for(var i=0;i<node.children.length;i++)1!=node.children[i].folder&&urls.push(node.children[i].data.url);return urls}function disabledItem(item){const node=getNodeById(item.data.id);var cnt=0;if(!node.hasChildren())return!0;for(var i=0;i<node.children.length;i++)1!=node.children[i].folder&&cnt++;return 0==cnt||void 0}function updateSourcePosition(children){if(null!=children){for(var i=0;i<children.length;i++)children[i].data.position=i+1;updatePosition(children)}}function addNodeWithImport(rootNode){$("#menuTree").fancytree("getRootNode").children[1].addChildren(rootNode),activeNode=$("#menuTree").fancytree("getTree").getActiveNode();activeNode.children;$(document).ready((function(){refreshMainTreeContent(activeNode.data.id)}))}function addNodeNewFolder(node,data){var newNode=getNodeById(node.data.id).addChildren({title:data.title,folder:data.isFolder?data.isFolder:1,data:{id:data.id,parent:node.data.id},type:"bookmark"});return newNode.match=!0,refreshMainTreeContent(node.data.id),newNode}function addNewNode(parentNode,data){var newNode=getNodeById(parentNode.data.id).addChildren({data:{id:data.id,parent:data.parent,url:data.url?data.url:""},title:data.title,folder:data.isFolder,type:"bookmark"});return parentNode.data.id===originNode.data.id&&refreshMainTreeContent(parentNode.data.id),newNode}async function addNodeNewBookmark(bookmark){const where={equals:[{key:"TITLE",value:bookmark.title},{key:"PARENT",value:bookmark.parent},{key:"IS_DELETED",value:"0"},{key:"FOLDER",value:0}]},addedBookmark=await DB.Query.bookmarks({selection:["_ID as ID","URL"],where:where});var parentId=bookmark.parent;addNewNode(getNodeById(parentId),{id:addedBookmark[0].ID,parent:bookmark.parent,title:bookmark.title,isFolder:0,url:addedBookmark[0].URL})}function moveBookmarksCallback(parent,movedNodes){var oldParentId=getParentId(movedNodes[0]),newParentNode=getNodeById(parseInt(parent.id));newParentNode||(newParentNode=folderTree.getNodeByKey(parent.key)),movedNodes.forEach((node=>{getNodeById(node.data.id).moveTo(newParentNode)})),closeEditMode();var oldParentNode=getNodeById(oldParentId);originNode=oldParentNode,viewNode(oldParentNode)}function pasteCopiedBookmarksCallBack(parent){var parentNode=getNodeById(parent);copyingNodes.forEach((node=>{node.copyTo(parentNode)})),refreshMainTreeContent(parent),copyingNodes=[],selectedNodes=[]}function deleteBookmarkOrTab(node){var children,id=node.data.id,title=node.title,parentId=getParentId(node),url=node.data.url,active=getNodeById(parentId),nodeIndex=node.getIndex();originChildrenNodes=null,originChildrenNodes=$.extend({},active.getChildren()),children=$.extend([],getNodeById(node.data.id).getChildren()),folderTree.getNodeByKey(node.key).remove(),children&&originChildrenNodes[nodeIndex]&&!originChildrenNodes[nodeIndex].getChildren()&&originChildrenNodes[nodeIndex].addChildren(children),MenuContentView.searchResultsEnabled&&MenuContentView.triggerSearch(),showNotice(ONE_ITEM_DELETED,MenuContentView.texts.UNDO,"normal"),closeEditMode(),deleteTimeout=setTimeout((function(){removeNotice(),"bookmark"===node.type?removeBookmark_fancytree({id:id,title:title,isFolder:!!node.folder,parent:parentId,url:url}):removeTab_fancytree({id:id,title:title,isFolder:!1,parent:parentId,url:url})}),3e3),updateSourcePosition(node.data.parent.children),originNode=getNodeById(parentId),viewNode(getNodeById(parentId))}function undoBookmarkDelete(){var active=getNodeById(originNode.data.id);Object.keys(originChildrenNodes).map((key=>{const child=originChildrenNodes[key];child.parent||(child.parent=active,active.addChildren($.extend({},child)))})),active=getNodeById(originNode.data.id);for(var i=0;i<active.children.length;i++)folderTree.getNodeByKey(originChildrenNodes[i].key).moveTo(active,"child");viewNode(getNodeById(originNode.data.id)),updateSourcePosition(active.children)}function showNotice(message,action,type){document.getElementById("notifyContainer").classList.add("show"),MenuContentView.notification.message=message,MenuContentView.notification.action=action,MenuContentView.notification.type=type}function removeNotice(){deleteTimeout=null,document.getElementById("notifyContainer").classList.remove("show")}function refreshMainTreeContent(nodeId){var node={children:Object.assign({},getNodeById(nodeId)).children};node.children&&node.children.length&&(node.children=node.children.map((children=>({...children,children:[]}))));var source={node:node};mainTreeObj.mainTreeInit(source)}function closeEditMode(){MenuContentView.isOpenEditBar&&MenuContentView.toggleEditBar(!1),MenuContentView.onEditSearchResults&&MenuContentView.toggleEditSearchMode(!1)}function renderBookmarksTree(){document.getElementById("bookmarks").classList.remove("partial-load"),MenuContentView.isSyncing=!1,getUpdateDBTreeSource().then((res=>{if(document.getElementById("syncedItems").innerText=stringifySyncedItems(),MenuContentView.importing){const index=treeSource[0].children.findIndex((child=>child.id==IMPORTED_FOLDER_IDS[getBrowserName().toUpperCase()]));index>=0&&treeSource[0].children[index].children&&treeSource[0].children[index].children.length&&(mainTree.reload(treeSource[0].children[index].children),folderTree.reload(treeSource),folderTree.rootNode.children[0].children[index].setActive(),MenuContentView.importing=!1)}else if(originNode){let expandedIds=[];folderTree.visit((function(node){node.isExpanded()&&node.data&&void 0!==node.data.id&&expandedIds.push(node.data.id)})),folderTree.reload(treeSource),folderTree.visit((function(node){node.data&&expandedIds.includes(node.data.id)&&node.setExpanded(!0)})),$("#menuTree").fancytree("getTree").filterNodes((function(node){return!!node.folder}));var node=getNodeById(originNode.data.id);MenuContentView.viewFolder=node}else folderTree?(folderTree.reload(treeSource),folderTree.rootNode.children[0].children[0].setActive()):initMenuTree()}))}function viewNode(target){target.children;MenuContentView.viewFolder=target,refreshMainTreeContent(target.data.id)}function selectAllBookmark(isSelect){mainTree.visit((function(node){node.data.parent.data.id===originNode.data.id&&node.setSelected(isSelect)}))}function clearSelectStatus(){MenuContentView.searchResultsEnabled?Object.keys(resultsTree).forEach((key=>{selectAllSearchResults(resultsTree[key],!1)})):mainTree&&mainTree.visit((function(node){node.setSelected(!1),node.setActive(!1)}))}function selectAllSearchResults(tree,isSelect){tree&&tree.visit((function(node){1==node.getLevel()&&node.setSelected(isSelect)}))}function refreshTreeSelectStatus(tree){tree&&tree.visit((function(node){node.setSelected(!1),node.setActive(!1)}))}$(document).on("click",".dialog-close",(function(e){$(this).parents(".ui-dialog-content").dialog("close")})),document.addEventListener("keyup",(function(event){storageLocalApi.getItem(SYNC_STATUS)!=SYNC_STARTED&&originNode&&onHandleKeyMappingEvent(originNode)}));