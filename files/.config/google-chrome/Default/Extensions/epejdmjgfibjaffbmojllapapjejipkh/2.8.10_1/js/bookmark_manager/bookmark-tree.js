var treeSource=getDBTreeForManager(),isSearchEnabled=!1,isEditBarEnabled=!1,originChildren=null,deletedNode=null,nextSibling=null,prevSibling=null,selectedNodes=[],copyingNodes=[],cuttingNodes=[];const mainTreeElement=document.getElementById("mainTree"),editSelectionWrapper=document.getElementById("editSelectionWrapper"),headerBack=document.getElementById("headerButton-back"),deleteBookmarkBtn=document.getElementById("deleteBookmarkBtn"),bookmarkSelectionBtn=document.getElementById("editSelection"),noItem=document.getElementById("no-item");headerBack.onclick=handleEditBack,deleteBookmarkBtn.onclick=onDeleteSelectedBookmark,bookmarkSelectionBtn.onclick=onEditSelectAllBookmark;const ENTER_KEY=13;mainTreeObj={};var folderTree=null,mainTree=null;function getAllChildrenURL(opt){var node=$.ui.fancytree.getNode(opt.$trigger),urls=[];if(node.hasChildren())for(var i=0;i<node.children.length;i++)1!=node.children[i].folder&&urls.push(node.children[i].data.url);return urls}function disabledItem(node){var cnt=0;if(!node.hasChildren())return!0;for(var i=0;i<node.children.length;i++)1!=node.children[i].folder&&cnt++;return 0==cnt||void 0}function updateSourcePosition(children){if(null!=children){for(var i=0;i<children.length;i++)children[i].data.position=i+1;updatePosition(children)}}function addNodeWithImport(rootNode){$("#folderTree").fancytree("getRootNode").children[1].addChildren(rootNode),activeNode=$("#folderTree").fancytree("getTree").getActiveNode();var source={node:{children:activeNode.children}};$(document).ready((function(){mainTreeObj.mainTreeInit(source)}))}function handleEditBack(){editSelectionWrapper.classList.remove("slide-in"),editSelectionWrapper.classList.add("slide-out"),mainTreeElement.classList.remove("editMode"),mainTree.visit((function(node){node.setSelected(!1)})),setTimeout((()=>{editSelectionWrapper.style.display="none"}),250),isEditBarEnabled=!1}function onChangeSelectedNodes(){document.querySelector(".selectedBookmarksTxt").innerText=`${selectedNodes.length} selected`;const activeNode=folderTree.getActiveNode(),selectedBookmarkCnt=selectedNodes.length,bookmarksViewCnt=activeNode&&activeNode.children?activeNode.children.length:0;deleteBookmarkBtn.style.display=selectedBookmarkCnt?"flex":"none",bookmarkSelectionBtn.style.display=bookmarksViewCnt?"flex":"none",deleteBookmarkBtn.querySelector(".buttonTxt").innerText=selectedBookmarkCnt==bookmarksViewCnt?"Delete all":"Delete",bookmarkSelectionBtn.querySelector(".buttonTxt").innerText=selectedBookmarkCnt==bookmarksViewCnt?"Deselect all":"Select all",bookmarkSelectionBtn.classList[selectedBookmarkCnt==bookmarksViewCnt?"add":"remove"]("allSelected")}function onDeleteSelectedBookmark(){selectedNodes.length>1?deleteMultiBookmarkOrTab(selectedNodes[0]):1===selectedNodes.length&&deleteBookmarkOrTab(selectedNodes[0])}function onEditSelectAllBookmark(){const activeNode=folderTree.getActiveNode();selectAllBookmark(selectedNodes.length!=(activeNode.children?activeNode.children.length:0))}function addNewNode(node,data){var newNode=getNodeById(node.data.id).addChildren({data:{id:data.id},title:data.title,folder:data.isFolder,url:data.url?data.url:"",type:"bookmark"});if(node.data.id===selectedNodes[0].data.parent.data.id){var source={node:node={children:getNodeById(node.data.id).children}};mainTreeObj.mainTreeInit(source)}return newNode}function dialogEditBookmark(node){const target={dataset:{id:node.data.id,title:node.title,parentId:node?getParentId(node):"0",url:node.data.url,isFolder:1==node.folder&&"true",targetNode:node}};onEditClick({},target)}function dialogMoveBookmark(node){MoveModal.parent.id=node&&"object"==typeof node.data.parent?node.data.parent.data.id:node.data.parent,MoveModal.selectedBookmarks=selectedNodes,MoveModal.toggle()}function moveBookmarksCallback(parent,movedNodes){var oldParentId="object"==typeof movedNodes[0].data.parent?movedNodes[0].data.parent.data.id:movedNodes[0].data.parent,newParentNode=getNodeById(parseInt(parent.id));newParentNode||(newParentNode=folderTree.getNodeByKey(parent.key)),movedNodes.forEach((node=>{folderTree.getNodeByKey(node.key).moveTo(newParentNode)})),refreshMainTreeContent(oldParentId)}async function pasteCopiedBookmarksCallBack(parent){var parentNode=getNodeById(parent);const copiedBoomarks=Array.from(copyingNodes).map((node=>DB.Query.bookmarks({selection:["_ID as ID"],equals:[{key:"TITLE",value:node.title},{key:"URL",value:node.data.url},{key:"PARENT",value:parent},{key:"IS_DELETED",value:"0"},{key:"FOLDER",value:parseInt(node.folder)}]}))),IDs=await Promise.all(copiedBoomarks);copyingNodes.forEach(((node,index)=>{node.data.id=IDs[index][0].ID,node.copyTo(parentNode,node.hitMode,(function(n){delete n.key}))})),refreshMainTreeContent(parent),copyingNodes=[],selectedNodes=[]}function deleteBookmarkOrTab(node){var id=node.data.id,title=node.title,parentId=getParentId(node),url=node.data.url;deletedNode=$.extend({},node),nextSibling=node.getNextSibling(),prevSibling=node.getPrevSibling(),"bookmark"===node.type?removeBookmark_fancytree({id:id,title:title,isFolder:!!node.folder,parent:parentId,url:url}):removeTab_fancytree({id:id,title:title,isFolder:!1,parent:parentId,url:url}),folderTree.getNodeByKey(node.key).remove();const children=getChildrenNodes(node);children.length&&updateSourcePosition(children),refreshMainTreeContent(parentId);var option={type:"basic",iconUrl:"assets/img/logo48x48.png",title:"Samsung Internet",message:`Deleted '${title}'`,priority:1,buttons:[{title:"Undo"}]};chrome.notifications.create("delteNotify",option,(function(){})),setTimeout((function(){chrome.notifications.clear("delteNotify",(function(){}))}),3e3)}function selectAllBookmark(isSelect){const activeNode=folderTree.getActiveNode();mainTree.visit((function(node){node.data.parent.data.id===activeNode.data.id&&node.setSelected(isSelect)}))}function refreshMainTreeContent(nodeId){clearSelectedNodes();let activeNode=getNodeById(nodeId);activeNode||(activeNode=folderTree.rootNode.children[0]),activeNode.setActive();var source={node:{children:activeNode.children}};mainTreeObj.mainTreeInit(source)}function clearSelectedNodes(){selectedNodes=[],onChangeSelectedNodes()}$((function(){function loadItems($trigger,moreOption=!1){var node=$.ui.fancytree.getNode($trigger);return 1==moreOption?function(node){var activeNode=folderTree.getActiveNode(),isBookmarkTree="bookmark"==activeNode.type,disabled=!isBookmarkTree||activeNode.data.id===IMPORTED_MAIN_FOLDER_IDS.BOOKMARKS,exportDisabled=!isBookmarkTree,sortDisabled=disabled||!activeNode.children;return items={edit:{name:CONTEXT_EDIT,icon:"icon",disabled:disabled,callback:function(key,opt){editSelectionWrapper.style.display="block",editSelectionWrapper.classList.remove("slide-out"),editSelectionWrapper.classList.add("slide-in"),mainTreeElement.classList.add("editMode"),isEditBarEnabled=!0,onChangeSelectedNodes()}},AddNewBookmark:{name:POPUP_ADD_NEW_BOOKMARK,icon:"bookmark",disabled:disabled,callback:function(itemKey,opt,e){var node=folderTree.getActiveNode();$("#dialog-bookmark-name").val(""),$("#dialog-bookmark-url").val(""),$("#dialog-form-add-bookmark").data("node",node).dialog("open")}},AddNewFolder:{name:POPUP_ADD_NEW_FOLDER,icon:"folder",disabled:disabled,callback:function(itemKey,opt,e){var node=folderTree.getActiveNode();$("#dialog-folder-name").val(""),$("#dialog-form-add-folder").data("node",node).dialog("open")}},sep1:"--",sort:{name:CONTEXT_SORT_BY_NAME,icon:"icon",disabled:sortDisabled,callback:function(itemKey,opt,e){var node=folderTree.getActiveNode();originChildren=null,originChildren=$.extend({},node.getChildren()),node.sortChildren(null,!1);for(var folderNode=new Array,i=node.children.length-1;i>0;i--)1===node.children[i].folder&&folderNode.push(node.children[i]);for(i=0;i<folderNode.length;i++)folderNode[i].moveTo(node,"firstChild");updateSourcePosition(node.children);var source={node:node={children:node.children}};mainTreeObj.mainTreeInit(source),chrome.notifications.create("sortNotify",{type:"basic",iconUrl:"assets/img/logo48x48.png",title:"Samsung Internet",message:"Sorted folders",priority:1,buttons:[{title:"Undo"}]},(function(){})),setTimeout((function(){chrome.notifications.clear("sortNotify",(function(){}))}),3e3)}},ImportBookmarks:{name:CONTEXT_IMPORT_BOOKMARKS,icon:"import",disabled:disabled,callback:function(itemKey,opt,e){const fileInput=document.getElementById("bookmark-file-input");fileInput.addEventListener("change",handleFileSelect),fileInput.click()}},ExportBookmarks:{name:CONTEXT_EXPORT_BOOKMARKS,icon:"export",disabled:exportDisabled,callback:function(itemKey,opt,e){exportHTMLBookmarks()}}},items}():node.span.className.indexOf("fancytree-selected")>=0&&selectedNodes.length>1&&"bookmark"==node.type?function(){var openAllBookmarksDisable,onSyncing=!1,urls=getAllURLSelected();if(storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED&&(onSyncing=!0),openAllBookmarksDisable=onSyncing||!urls.length,hasSelectedFolder()){items={openInNewTab:{name:CONTEXT_OPEN_NEW_TAB,icon:"open",disabled:openAllBookmarksDisable,callback:function(itemKey,opt,e){openUrl([urls],"OPEN_ALL_BOOKMARKS")}},openInNewWindow:{name:CONTEXT_OPEN_NEW_WINDOW,icon:"open",disabled:openAllBookmarksDisable,callback:function(itemKey,opt,e){openUrl([urls],"OPEN_ALL_NEW_WINDOW")}},openAllInSecretWindow:{name:CONTEXT_OPEN_ALL_IN_SECRET_WINDOW,icon:"open",disabled:openAllBookmarksDisable,callback:function(itemKey,opt,e){openUrl([urls],"OPEN_ALL_NEW_SECRET_WINDOW")}},sep1:"--"};let bottomItems={move:{name:CONTEXT_MOVE,icon:"icon",disabled:onSyncing,callback:function(key,opt){dialogMoveBookmark($.ui.fancytree.getNode(opt.$trigger))}}},deleteItem={};isEditBarEnabled||(deleteItem.delete={name:CONTEXT_DELETE,icon:"icon",disabled:onSyncing,callback:function(itemKey,opt,e){var node=$.ui.fancytree.getNode(opt.$trigger);deleteMultiBookmarkOrTab(node)}}),items=Object.assign({},items,deleteItem,bottomItems)}else{items={openInNewTab:{name:CONTEXT_OPEN_NEW_TAB,icon:"open",disabled:onSyncing,callback:function(itemKey,opt,e){openUrl([urls],"OPEN_ALL_BOOKMARKS")}},openInNewWindow:{name:CONTEXT_OPEN_NEW_WINDOW,icon:"open",disabled:onSyncing,callback:function(itemKey,opt,e){openUrl([urls],"OPEN_ALL_NEW_WINDOW")}},openAllInSecretWindow:{name:CONTEXT_OPEN_ALL_IN_SECRET_WINDOW,icon:"open",disabled:onSyncing,callback:function(itemKey,opt,e){openUrl([urls],"OPEN_ALL_NEW_SECRET_WINDOW")}},sep1:"--"};let bottomItems={move:{name:CONTEXT_MOVE,icon:"icon",disabled:onSyncing,callback:function(key,opt){dialogMoveBookmark($.ui.fancytree.getNode(opt.$trigger))}},copy:{name:CONTEXT_COPY,icon:"icon",disabled:onSyncing,callback:function(itemKey,opt,e){copySelectedNodes()}}},deleteItem={};isEditBarEnabled||(deleteItem.delete={name:CONTEXT_DELETE,icon:"icon",disabled:onSyncing,callback:function(itemKey,opt,e){var node=$.ui.fancytree.getNode(opt.$trigger);deleteMultiBookmarkOrTab(node)}}),items=Object.assign({},items,deleteItem,bottomItems)}return items}():(null!=node&&node.span.className.indexOf("fancytree-selected")<0&&(selectedNodes=[],mainTree.selectAll(!1),node.setActive(),isEditBarEnabled&&node.setSelected(!0)),"bookmark"==node.type?function(node){var items,deleteDisable,disable=disabledItem(node);if((node.data.id==IMPORTED_FOLDER_IDS.CHROME||IMPORTED_FOLDER_IDS.SBROWSER)&&(deleteDisable=!0),storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED&&(deleteDisable=!0),1==node.folder&&node.data.id<0&&node.data.id!=IMPORTED_FOLDER_IDS.SBROWSER)items={delete:{name:CONTEXT_DELETE+"(D)",icon:"icon",disabled:deleteDisable,callback:function(itemKey,opt,e){var id=(node=$.ui.fancytree.getNode(opt.$trigger)).data.id,title=node.title,url=node.data.url;deletedNode=$.extend({},node),nextSibling=node.getNextSibling(),prevSibling=node.getPrevSibling(),removeBookmark_fancytree({e:e,id:id,title:title,isFolder:!0,url:url}),updateSourcePositionTemp(node.data.parent.children);var node,source={node:node={children:node.data.parent.children}};mainTreeObj.mainTreeInit(source);var option={type:"basic",iconUrl:"assets/img/logo48x48.png",title:"Samsung Internet",message:`Deleted '${title}'`,priority:1,buttons:[{title:"Undo"}]};chrome.notifications.create("delteNotify",option,(function(){})),setTimeout((function(){chrome.notifications.clear("delteNotify",(function(){}))}),3e3)}},sep1:"--",openAllBookmarks:{name:CONTEXT_OPEN_ALL_BOOKMAKRS,icon:"open",disabled:disable,callback:function(itemKey,opt,e){var urls=getAllChildrenURL(opt);openUrl([urls],"OPEN_ALL_BOOKMARKS")}},openAllInNewWindow:{name:CONTEXT_OPEN_ALL_IN_NEW_WINDOW,icon:"open",disabled:disable,callback:function(itemKey,opt,e){var urls=getAllChildrenURL(opt);openUrl([urls],"OPEN_ALL_NEW_WINDOW")}},openAllInSecretWindow:{name:CONTEXT_OPEN_ALL_IN_SECRET_WINDOW,icon:"open",disabled:disable,callback:function(itemKey,opt,e){var urls=getAllChildrenURL(opt);openUrl([urls],"OPEN_ALL_NEW_SECRET_WINDOW")}}};else if(1!=node.folder){disable=!1,storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED&&(disable=!0),items={open:{name:OPEN,icon:"open",callback:function(itemKey,opt,e){var url=$.ui.fancytree.getNode(opt.$trigger).data.url;openUrl([url],"OPEN")}},openInNewTab:{name:CONTEXT_OPEN_NEW_TAB,icon:"open",callback:function(itemKey,opt,e){var url=$.ui.fancytree.getNode(opt.$trigger).data.url;openUrl([url],"OPEN_NEW_TAB")}},openInNewWindow:{name:CONTEXT_OPEN_NEW_WINDOW,icon:"open",callback:function(itemKey,opt,e){var url=$.ui.fancytree.getNode(opt.$trigger).data.url;openUrl([url],"OPEN_NEW_WINDOW")}},openInSecretWindow:{name:CONTEXT_OPEN_IN_SECRET_WINDOW,icon:"open",callback:function(itemKey,opt,e){var url=$.ui.fancytree.getNode(opt.$trigger).data.url;openUrl([url],"OPEN_NEW_SECRET_WINDOW")}},sep1:"--"};let bottomItems={move:{name:CONTEXT_MOVE,icon:"icon",disabled:disable,callback:function(key,opt){var node=$.ui.fancytree.getNode(opt.$trigger);selectedNodes=[node],dialogMoveBookmark(node)}},edit:{name:CONTEXT_EDIT,icon:"icon",disabled:disable,callback:function(key,opt){var node=$.ui.fancytree.getNode(opt.$trigger);$("#dialog-name").val(node.title),$("#dialog-url").val(node.data.url),$("#dialog-form").data("node",node).dialog("open")}},copy:{name:CONTEXT_COPY,icon:"icon",disabled:disable,callback:function(itemKey,opt,e){var node=$.ui.fancytree.getNode(opt.$trigger);selectedNodes=[node],copySelectedNodes()}}},deleteItem={};isEditBarEnabled||(deleteItem.delete={name:CONTEXT_DELETE,icon:"icon",disabled:disable,callback:function(itemKey,opt,e){deleteBookmarkOrTab($.ui.fancytree.getNode(opt.$trigger))}}),items=Object.assign({},items,deleteItem,bottomItems)}else{var openAllBookmarksDisable,onSyncing=!1;storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED&&(onSyncing=!0),openAllBookmarksDisable=onSyncing||disabledItem(node),items={openAllBookmarks:{name:CONTEXT_OPEN_NEW_TAB,icon:"open",disabled:openAllBookmarksDisable,callback:function(itemKey,opt,e){var urls=getAllChildrenURL(opt);openUrl([urls],"OPEN_ALL_BOOKMARKS")}},openAllInNewWindow:{name:CONTEXT_OPEN_NEW_WINDOW,icon:"open",disabled:openAllBookmarksDisable,callback:function(itemKey,opt,e){var urls=getAllChildrenURL(opt);openUrl([urls],"OPEN_ALL_NEW_WINDOW")}},openAllInSecretWindow:{name:CONTEXT_OPEN_ALL_IN_SECRET_WINDOW,icon:"open",disabled:openAllBookmarksDisable,callback:function(itemKey,opt,e){var urls=getAllChildrenURL(opt);openUrl([urls],"OPEN_ALL_NEW_SECRET_WINDOW")}},sep1:"--"};let bottomItems={move:{name:CONTEXT_MOVE,icon:"icon",disabled:onSyncing,callback:function(key,opt){var node=$.ui.fancytree.getNode(opt.$trigger);selectedNodes=[node],dialogMoveBookmark(node)}},edit:{name:CONTEXT_EDIT,icon:"icon",disabled:onSyncing,callback:function(key,opt){dialogEditBookmark($.ui.fancytree.getNode(opt.$trigger))}}},deleteItem={};isEditBarEnabled||(deleteItem.delete={name:CONTEXT_DELETE,icon:"icon",disabled:onSyncing,callback:function(itemKey,opt,e){deleteBookmarkOrTab($.ui.fancytree.getNode(opt.$trigger))}}),items=Object.assign({},items,deleteItem,bottomItems)}return items}(node):function(node){var disable,items,deleteDisable;return node.data.id==IMPORTED_MAIN_FOLDER_IDS.TABS&&(deleteDisable=!0),storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED&&(deleteDisable=!0),1==node.folder?(disable=disabledItem(node),items={openAllBookmarks:{name:CONTEXT_OPEN_ALL,icon:"open",disabled:disable,callback:function(itemKey,opt,e){var urls=getAllChildrenURL(opt);openUrl([urls],"OPEN_ALL_BOOKMARKS")}},openAllInNewWindow:{name:CONTEXT_OPEN_ALL_IN_NEW_WINDOW,icon:"open",disabled:disable,callback:function(itemKey,opt,e){var urls=getAllChildrenURL(opt);openUrl([urls],"OPEN_ALL_NEW_WINDOW")}},openAllInSecretWindow:{name:CONTEXT_OPEN_ALL_IN_SECRET_WINDOW,icon:"open",disabled:disable,callback:function(itemKey,opt,e){var urls=getAllChildrenURL(opt);openUrl([urls],"OPEN_ALL_NEW_SECRET_WINDOW")}},sep1:"--",delete:{name:CONTEXT_DELETE_ALL+"(D)",icon:"icon",disabled:deleteDisable,callback:function(itemKey,opt,e){var id=(node=$.ui.fancytree.getNode(opt.$trigger)).data.id,title=node.title,url=node.data.url;deletedNode=$.extend({},node),nextSibling=node.getNextSibling(),prevSibling=node.getPrevSibling(),removeTab_fancytree({e:e,id:id,title:title,isFolder:!0,url:url}),folderTree.getNodeByKey(node.key).remove();var node,source={node:node={children:node.data.parent.children}};mainTreeObj.mainTreeInit(source);var option={type:"basic",iconUrl:"assets/img/logo48x48.png",title:"Samsung Internet",message:`Deleted '${title}'`,priority:1,buttons:[{title:"Undo"}]};chrome.notifications.create("delteNotify",option,(function(){})),setTimeout((function(){chrome.notifications.clear("delteNotify",(function(){}))}),3e3)}}}):(storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED&&(disable=!0),items={copyURL:{name:CONTEXT_COPY_URL,icon:"icon",callback:function(key,opt,e){var node=$.ui.fancytree.getNode(opt.$trigger),$temp=$("<input>");$("body").append($temp),$temp.val(node.data.url).select(),document.execCommand("copy"),$temp.remove();const not=new Notification("",{body:"URL copied.",icon:"assets/img/logo48x48.png"});setTimeout(not.close.bind(not),3e3)}},openInNewTab:{name:CONTEXT_OPEN_NEW_TAB,icon:"open",callback:function(itemKey,opt,e){var url=$.ui.fancytree.getNode(opt.$trigger).data.url;openUrl([url],"OPEN_NEW_TAB")}},openInNewWindow:{name:CONTEXT_OPEN_NEW_WINDOW,icon:"open",callback:function(itemKey,opt,e){var url=$.ui.fancytree.getNode(opt.$trigger).data.url;openUrl([url],"OPEN_NEW_WINDOW")}},openInSecretWindow:{name:CONTEXT_OPEN_IN_SECRET_WINDOW,icon:"open",callback:function(itemKey,opt,e){var url=$.ui.fancytree.getNode(opt.$trigger).data.url;openUrl([url],"OPEN_NEW_SECRET_WINDOW")}},sep1:"--",delete:{name:CONTEXT_DELETE+"(D)",icon:"icon",disabled:disable,callback:function(itemKey,opt,e){var id=(node=$.ui.fancytree.getNode(opt.$trigger)).data.id,title=node.title,parentId=node.data.parent.data.id,url=node.data.url;deletedNode=$.extend({},node),nextSibling=node.getNextSibling(),prevSibling=node.getPrevSibling(),removeTab_fancytree({e:e,id:id,title:title,isFolder:!1,parent:parentId,url:url}),folderTree.getNodeByKey(node.key).remove();var node,source={node:node={children:node.data.parent.children}};mainTreeObj.mainTreeInit(source);var option={type:"basic",iconUrl:"assets/img/logo48x48.png",title:"Samsung Internet",message:`Deleted '${title}'`,priority:1,buttons:[{title:"Undo"}]};chrome.notifications.create("delteNotify",option,(function(){})),setTimeout((function(){chrome.notifications.clear("delteNotify",(function(){}))}),3e3)}}}),items}(node))}mainTreeObj={mainTreeInit:function(data){null==mainTree&&($("#mainTree").fancytree({extensions:["themeroller","dnd","multi"],source:data.node.children||[],toggleEffect:!1,multi:{mode:"sameParent"},dnd:{preventVoidMoves:!0,preventRecursiveMoves:!0,autoExpandMS:!1,draggable:{zIndex:1e3,scroll:!1,containment:"parent",revert:"invalid"},multiSource:!0,initHelper:function(node,data){var helper=data.ui.helper,sourceNodes=data.tree.getSelectedNodes();node.isSelected()||sourceNodes.unshift(node),helper.data("sourceNodes",sourceNodes),$(".fancytree-active,.fancytree-selected",mainTree.$container).addClass("fancytree-drag-source"),sourceNodes.length>1&&helper.append($("<span class='fancytree-childcounter'/>").text("+"+(sourceNodes.length-1))),helper.prepend($("<span class='fancytree-dnd-modifier'/>").text("+").hide())},updateHelper:function(node,data){var event=data.originalEvent,tree=node.tree,copyMode=event.ctrlKey||event.altKey;data.ui.helper.find(".fancytree-dnd-modifier").toggle(copyMode),$(".fancytree-drag-source",tree.$container).toggleClass("fancytree-drag-remove",!copyMode)},dragStart:function(node,data){return!(node.data.id<0&&node.data.id!=IMPORTED_FOLDER_IDS.SBROWSER||"tab"===node.type)},dragEnter:function(node,data){return"tab"!==node.type},dragOver:function(node,data){const dndMarker=document.getElementById("fancytree-drop-marker");(data.node.folder||"over"!=data.hitMode)&&dndMarker?dndMarker.style.visibility="visible":dndMarker.style.visibility="hidden"},dragDrop:function(node,data){if(storageLocalApi.getItem(SYNC_STATUS)!=SYNC_STARTED&&(0!==node.folder||"over"!==data.hitMode)&&"tab"!==node.type){var sourceNodes=data.ui.helper.data("sourceNodes"),isCrossTree=!1;sourceNodes[0].tree!=data.tree?(isCrossTree=!0,$.each(sourceNodes,(function(i,o){folderTree.getNodeByKey(o.key).data.parent=node.data.id,folderTree.getNodeByKey(o.key).moveTo(folderTree.getNodeByKey(node.key),data.hitMode)}))):$.each(sourceNodes,(function(i,o){"over"===data.hitMode&&(folderTree.getNodeByKey(o.key).data.parent=node.data.id),folderTree.getNodeByKey(o.key).moveTo(folderTree.getNodeByKey(node.key),data.hitMode)}));var children=null;children=isCrossTree?folderTree.getNodeByKey(data.otherNode.parent.key).parent.children:"over"===data.hitMode?folderTree.getNodeByKey(node.key).children:folderTree.getNodeByKey(node.key).parent.children,isCrossTree&&(children=folderTree.getNodeByKey(node.key).parent.children),updateSourcePosition(children);var source={node:node={children:children}};mainTreeObj.mainTreeInit(source)}}},tooltip:function(event,data){return data.node.title},renderNode:function(event,data){let node=data.node;var $span=$(node.span),checkBox=document.createElement("span");if(checkBox.className="checkBox",$span[0].prepend(checkBox),1==node.folder)return;var href=node.data.url,faviconURL=`${h("a",{href:href}).origin}/favicon.ico`;const initial=url2title(faviconURL).substr(0,1).toUpperCase();var iconSpan=$span.find("> span.fancytree-icon")[0];iconSpan.style.backgroundColor="#BABABA";var text=document.createElement("span");text.className="thumbnail",iconSpan.appendChild(text),$span.find("> span.fancytree-icon").find("> span.thumbnail")[0].innerHTML=initial,iconSpan.appendChild(h("img",{class:"bookmark_entry_image",style:"display: none;",load(e){iconSpan.style.backgroundColor="",iconSpan.querySelector("span").style.display="none",this.style.display="block"},src:faviconURL}))},dblclick:function(e,data){return!isEditBarEnabled&&(1==data.node.folder?(folderTree.activateKey(data.node.key),!1):void openUrl([data.node.data.url],"OPEN_NEW_TAB"))},click:function(e,data){if(data.node.span.classList.contains("fancytree-drag-source"))return!1;if("fancytree-more-option"==data.originalEvent.target.className)$.contextMenu({selector:"img.fancytree-more-option",trigger:"left",build:function($trigger,e){return{callback:function(key,options){},items:loadItems($trigger)}}});else if(isEditBarEnabled||e.ctrlKey||e.shiftKey)!isEditBarEnabled||e.ctrlKey||e.shiftKey||(data.node.setSelected(!data.node.selected),data.node.setFocus(!1),data.node.setActive(data.node.selected),e.preventDefault());else{if(1==data.node.folder)return folderTree.activateKey(data.node.key),!1;openUrl([data.node.data.url],"OPEN_NEW_TAB")}},keydown:function(event,data){if(disableMovingSelectedNode(event))return!1},select:function(event,data){selectedNodes=data.tree.getSelectedNodes(),isEditBarEnabled&&storageLocalApi.getItem(SYNC_STATUS)!=SYNC_STARTED&&onChangeSelectedNodes()}}),mainTree=$("#mainTree").fancytree("getTree")),mainTree.clear(),data.node.children?(mainTree.reload(data.node.children),mainTree.visit((function(node){node.setExpanded(!1)})),noItem.style.display="none"):noItem.style.display="block"}},$("#folderTree").fancytree({extensions:["themeroller","filter","dnd"],source:treeSource,toggleEffect:!1,filter:{mode:"hide"},dnd:{preventVoidMoves:!0,preventRecursiveMoves:!0,autoExpandMS:400,multiSource:!0,draggable:{zIndex:1e3,scroll:!1,containment:"parent",revert:"invalid"},initHelper:function(node,data){var helper=data.ui.helper,sourceNodes=data.tree.getSelectedNodes();node.isSelected()||sourceNodes.unshift(node),helper.data("sourceNodes",sourceNodes),$(".fancytree-active,.fancytree-selected",mainTree.$container).addClass("fancytree-drag-source"),sourceNodes.length>1&&helper.append($("<span class='fancytree-childcounter'/>").text("+"+(sourceNodes.length-1))),helper.prepend($("<span class='fancytree-dnd-modifier'/>").text("+").hide())},updateHelper:function(node,data){var event=data.originalEvent,tree=node.tree,copyMode=event.ctrlKey||event.altKey;data.ui.helper.find(".fancytree-dnd-modifier").toggle(copyMode),$(".fancytree-drag-source",tree.$container).toggleClass("fancytree-drag-remove",!copyMode)},dragStart:function(node,data){return!(node.data.id<0&&node.data.id!=IMPORTED_FOLDER_IDS.SBROWSER||"tab"===node.type)},dragEnter:function(node,data){return!(node.data.id<0&&node.data.id!=IMPORTED_FOLDER_IDS.SBROWSER||"tab"===node.type)},dragDrop:function(node,data){if(storageLocalApi.getItem(SYNC_STATUS)!=SYNC_STARTED&&"tab"!==node.type){var sourceNodes=data.ui.helper.data("sourceNodes"),isCrossTree=!1,parentKey=null;sourceNodes[0].tree!=data.tree?(isCrossTree=!0,parentKey=folderTree.getNodeByKey(data.otherNode.key).parent.key,$.each(sourceNodes,(function(i,o){folderTree.getNodeByKey(o.key).data.parent=node.data.id,folderTree.getNodeByKey(o.key).moveTo(folderTree.getNodeByKey(node.key),data.hitMode)}))):$.each(sourceNodes,(function(i,o){"over"===data.hitMode&&(folderTree.getNodeByKey(o.key).data.parent=node.data.id),folderTree.getNodeByKey(o.key).moveTo(folderTree.getNodeByKey(node.key),data.hitMode)}));var children=null;updateSourcePosition(children=isCrossTree?folderTree.getNodeByKey(data.otherNode.key).parent.children:"over"===data.hitMode?folderTree.getNodeByKey(node.key).children:folderTree.getNodeByKey(node.key).parent.children),isCrossTree&&updateSourcePosition(children=folderTree.getNodeByKey(parentKey).children);var source={node:node={children:children}};mainTreeObj.mainTreeInit(source)}}},select:function(e,data){},activate:function(e,data){mainTreeObj.mainTreeInit(data),clearSelectedNodes(),isSearchEnabled&&($("input[name=search]").val(""),isSearchEnabled=!1)},click:function(e,data){if(isEditBarEnabled&&(data.node.data.id===IMPORTED_MAIN_FOLDER_IDS.BOOKMARKS||data.node.data.id===IMPORTED_MAIN_FOLDER_IDS.TABS))return!1;data.originalEvent.target&&data.originalEvent.target.className.indexOf("fancytree-expander")>=0&&e.preventDefault(),data.node.toggleExpanded(),data.node.setActive(),isSearchEnabled&&($("input[name=search]").val(""),isSearchEnabled=!1)},keydown:function(event,data){if(disableMovingSelectedNode(event))return!1},tooltip:function(event,data){return data.node.title},renderNode:function(e,data){},init:function(e,data){folderTree.rootNode.children[0].setExpanded(!0),folderTree.rootNode.children[0].setActive()}}),(folderTree=$("#folderTree").fancytree("getTree")).filterNodes((function(node){return 0!==node.folder})),$.contextMenu({selector:"span.fancytree-title, img.bookmark_entry_image, span.thumbnail, span.fancytree-node",build:function($trigger,e){var node=$.ui.fancytree.getNode($trigger);node.setActive(!0);return!([IMPORTED_MAIN_FOLDER_IDS.BOOKMARKS,IMPORTED_MAIN_FOLDER_IDS.TABS,IMPORTED_FOLDER_IDS.SBROWSER,IMPORTED_FOLDER_IDS.CHROME].indexOf(node.data.id)>=0)&&{callback:function(key,options){},items:loadItems($trigger)}}}),$.contextMenu({selector:"#moreOption",trigger:"left",build:function($trigger,e){return{callback:function(key,options){},items:loadItems($trigger,!0)}}}),$("#dialog-form").dialog({autoOpen:!1,width:350,modal:!0,buttons:[{text:SAVE,click:function(e,key){var id=(node=$(this).data("node")).data.id,title=$("#dialog-name").val(),parentId=node.data.parent.data.id,url=$("#dialog-url").val();updateBookmark({id:id,url:url,title:title,isFolder:!1,parent:parentId}),folderTree.getNodeByKey(node.key).title=title,folderTree.getNodeByKey(node.key).data.url=url;var node,source={node:node={children:folderTree.getNodeByKey(node.key).parent.children}};mainTreeObj.mainTreeInit(source),$(this).dialog("close")}},{text:CANCEL,click:function(){$(this).dialog("close")}}],create:function(){$(this).closest(".ui-dialog").find(".ui-button").eq(1).addClass("button-save")},open:function(){$(this).closest(".ui-dialog").find(".ui-button").eq(1).addClass("disabled");const onInputChange=function(){$("#dialog-name").val()&&$("#dialog-url").val()?$(this).closest(".ui-dialog").find(".ui-button").eq(1).removeClass("disabled"):$(this).closest(".ui-dialog").find(".ui-button").eq(1).addClass("disabled")};$("#dialog-name").on("input",onInputChange),$("#dialog-url").on("input",onInputChange);const onKeyPress=function(event){if(13==event.which&&!$(this).closest(".ui-dialog").find(".ui-button").eq(1)[0].classList.contains("disabled")){event.preventDefault(),$("#dialog-form").dialog("option").buttons[0].click.bind($("#dialog-form"))()}};$("#dialog-name").on("keypress",onKeyPress),$("#dialog-url").on("keypress",onKeyPress)},close:function(){$(this).dialog("close")}}),$("#dialog-form-rename").dialog({autoOpen:!1,width:350,modal:!0,buttons:[{text:SAVE,click:function(e,key){var parentId,parentKey,node=$(this).data("node"),id=node.data.id,title=$("#dialog-rename-name").val();node.tree.$div[0].className.includes("mainTree")?(parentId=node.data.parent.data.id,parentKey=node.data.parent.key):(parentId=node.data.parent,parentKey=node.key),updateBookmark({id:id,title:title,isFolder:!0,parent:parentId});var source={node:{children:folderTree.getNodeByKey(parentKey).children}};folderTree.getNodeByKey(node.key).setTitle(title),mainTreeObj.mainTreeInit(source),$(this).dialog("close")}},{text:CANCEL,click:function(){$(this).dialog("close")}}],create:function(){$(this).closest(".ui-dialog").find(".ui-button").eq(1).addClass("button-save")},open:function(){$(this).closest(".ui-dialog").find(".ui-button").eq(1).addClass("disabled"),$("#dialog-rename-name").on("input",(function(){$(this).closest(".ui-dialog").find(".ui-button").eq(1).removeClass("disabled")})),$("#dialog-rename-name").on("keypress",(function(event){if(13==event.which){event.preventDefault(),$("#dialog-form-rename").dialog("option").buttons[0].click.bind($("#dialog-form-rename"))()}}))},close:function(){$(this).dialog("close")}}),$("#dialog-form-add-bookmark").dialog({autoOpen:!1,width:350,modal:!0,buttons:[{text:SAVE,click:async function(e,key){var id=(node=$(this).data("node")).data.id,title=$("#dialog-bookmark-name").val(),url=$("#dialog-bookmark-url").val();const where={equals:[{key:"TITLE",value:title},{key:"PARENT",value:id},{key:"IS_DELETED",value:"0"},{key:"FOLDER",value:0}]};id==IMPORTED_FOLDER_IDS.SBROWSER&&(id=0),await addBookmark({url:url,title:title,parent:id,force:!0});const addedBookmark=await DB.Query.bookmarks({selection:["_ID as ID","URL"],where:where});folderTree.getNodeByKey(node.key).addChildren({title:title,data:{id:addedBookmark[0].ID,url:addedBookmark[0].URL},type:"bookmark"});var node,source={node:node={children:folderTree.getNodeByKey(node.key).children}};mainTreeObj.mainTreeInit(source),$(this).dialog("close")}},{text:CANCEL,click:function(){$(this).dialog("close")}}],create:function(){$(this).closest(".ui-dialog").find(".ui-button").eq(1).addClass("button-save")},open:function(){elementIds=["#dialog-bookmark-name","#dialog-bookmark-url"];const onInputChange=id=>{$(id).on("input",(function(){$("#dialog-bookmark-name").val()&&$("#dialog-bookmark-url").val()?$(this).closest(".ui-dialog").find(".ui-button").eq(1).removeClass("disabled"):$(this).closest(".ui-dialog").find(".ui-button").eq(1).addClass("disabled")}))},onKeyPress=id=>{$(id).on("keypress",(function(event){if(13==event.which&&!$(this).closest(".ui-dialog").find(".ui-button").eq(1)[0].classList.contains("disabled")){event.preventDefault(),$("#dialog-form-add-bookmark").dialog("option").buttons[0].click.bind($("#dialog-form-add-bookmark"))()}}))};$(this).closest(".ui-dialog").find(".ui-button").eq(1).addClass("disabled"),elementIds.forEach((id=>{onInputChange(id),onKeyPress(id)}))},close:function(){$(this).dialog("close")}}),$("#dialog-form-add-folder").dialog({autoOpen:!1,width:350,modal:!0,buttons:[{text:SAVE,click:async function(e,key){var id=(node=$(this).data("node")).data.id,title=$("#dialog-folder-name").val();id==IMPORTED_FOLDER_IDS.SBROWSER&&(id=0);const createdFolderId=await createFolder({title:title,parent:id,force:!0});folderTree.getNodeByKey(node.key).addChildren({title:title,data:{id:createdFolderId},folder:!0,type:"bookmark"}).match=!0;var node,source={node:node={children:folderTree.getNodeByKey(node.key).children}};mainTreeObj.mainTreeInit(source),$(this).dialog("close")}},{text:CANCEL,click:function(){$(this).dialog("close")}}],create:function(){$(this).closest(".ui-dialog").find(".ui-button").eq(1).addClass("button-save")},open:function(){$(this).closest(".ui-dialog").find(".ui-button").eq(1).addClass("disabled"),$("#dialog-folder-name").on("input",(function(){$("#dialog-folder-name").val()?$(this).closest(".ui-dialog").find(".ui-button").eq(1).removeClass("disabled"):$(this).closest(".ui-dialog").find(".ui-button").eq(1).addClass("disabled")})),$("#dialog-folder-name").on("keypress",(function(event){if(13==event.which&&(event.preventDefault(),!$(this).closest(".ui-dialog").find(".ui-button").eq(1)[0].classList.contains("disabled"))){$("#dialog-form-add-folder").dialog("option").buttons[0].click.bind($("#dialog-form-add-folder"))()}}))},close:function(){$(this).dialog("close")}}),$("input[name=search]").keyup((function(e){var activeNode=folderTree.getActiveNode();null!=activeNode&&activeNode.setActive(!1);var search=$(this).val().toLowerCase();if(""==search)return mainTree.clear(),void(isSearchEnabled=!1);var node=folderTree.getRootNode(),childrenArray=Array();const _recurse=node=>{node.data.id!=IMPORTED_FOLDER_IDS.CHROME&&node.data.id!=IMPORTED_FOLDER_IDS.SBROWSER&&-1!=node.title.toLowerCase().indexOf(search)&&childrenArray.push(node);const children=node.children;children&&children.length>0&&children.forEach((c=>_recurse(c)))};_recurse(node);var source={node:node={children:childrenArray}};mainTreeObj.mainTreeInit(source),isSearchEnabled=!0})),chrome.notifications.onButtonClicked.addListener((function(notificationId,buttonIndex){"sortNotify"==notificationId?(chrome.notifications.clear("sortNotify",(function(){})),function(){var children=(node=folderTree.getActiveNode()).children;if(null==children)return;for(var i=0;i<children.length;i++)folderTree.getNodeByKey(originChildren[i].key).moveTo(node,"child");updateSourcePosition(node.children);var node,source={node:node={children:node.children}};mainTreeObj.mainTreeInit(source)}()):"delteNotify"==notificationId&&(chrome.notifications.clear("delteNotify",(function(){})),function(){var node=null;null!=prevSibling?(node=folderTree.getNodeByKey(prevSibling.key)).addNode(deletedNode,"after"):null!=nextSibling?(node=folderTree.getNodeByKey(nextSibling.key)).addNode(deletedNode,"before"):(node=folderTree.getActiveNode()).addNode(deletedNode);var url=deletedNode.data.url,title=deletedNode.title,parent=deletedNode.data.parent.data.id;parent==IMPORTED_FOLDER_IDS.SBROWSER&&(parent=0);var isFolder=!1;1==deletedNode.folder&&(isFolder=!0);addBookmark({url:url,title:title,parent:parent,isFolder:isFolder}),deletedNode=null,nextSibling=null,prevSibling=null,updateSourcePosition((node=folderTree.getActiveNode()).children);var source={node:node={children:node.children}};mainTreeObj.mainTreeInit(source)}())}))})),$("#search")[0].placeholder=BOOKMARK_SEARCH,document.onselectstart=function(){return!1},document.addEventListener("keyup",(function(event){if(event.preventDefault(),event.stopPropagation(),storageLocalApi.getItem(SYNC_STATUS)==SYNC_STARTED||!folderTree)return;const activeNode=folderTree.getActiveNode();onHandleKeyMappingEvent(activeNode)}));