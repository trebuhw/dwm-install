/*!
 * jquery.fancytree.filter.js
 *
 * Remove or highlight tree nodes, based on a filter.
 * (Extension module for jquery.fancytree.js: https://github.com/mar10/fancytree/)
 *
 * Copyright (c) 2008-2018, Martin Wendt (http://wwWendt.de)
 *
 * Released under the MIT license
 * https://github.com/mar10/fancytree/wiki/LicenseInfo
 *
 * @version @VERSION
 * @date @DATE
 */
!function(factory){"function"==typeof define&&define.amd?define(["jquery","./jquery.fancytree"],factory):"object"==typeof module&&module.exports?(require("./jquery.fancytree"),module.exports=factory(require("jquery"))):factory(jQuery)}((function($){"use strict";var KeyNoData="__not_found__",escapeHtml=$.ui.fancytree.escapeHtml;function _escapeRegex(str){return(str+"").replace(/([.?*+\^\$\[\]\\(){}|-])/g,"\\$1")}function extractHtmlText(s){return s.indexOf(">")>=0?$("<div/>").html(s).text():s}return $.ui.fancytree._FancytreeClass.prototype._applyFilterImpl=function(filter,branchMode,_opts){var match,statusNode,re,reHighlight,temp,count=0,treeOpts=this.options,escapeTitles=treeOpts.escapeTitles,prevAutoCollapse=treeOpts.autoCollapse,opts=$.extend({},treeOpts.filter,_opts),hideMode="hide"===opts.mode,leavesOnly=!!opts.leavesOnly&&!branchMode;if("string"==typeof filter){if(""===filter)return this.warn("Fancytree passing an empty string as a filter is handled as clearFilter()."),void this.clearFilter();match=opts.fuzzy?filter.split("").reduce((function(a,b){return a+"[^"+b+"]*"+b})):_escapeRegex(filter),re=new RegExp(".*"+match+".*","i"),reHighlight=new RegExp(_escapeRegex(filter),"gi"),filter=function(node){if(!node.title)return!1;var text=escapeTitles?node.title:extractHtmlText(node.title),res=!!re.test(text);return res&&opts.highlight&&(escapeTitles?(temp=text.replace(reHighlight,(function(s){return"￷"+s+"￸"})),node.titleWithHighlight=escapeHtml(temp).replace(/\uFFF7/g,"<mark>").replace(/\uFFF8/g,"</mark>")):node.titleWithHighlight=text.replace(reHighlight,(function(s){return"<mark>"+s+"</mark>"}))),res}}return this.enableFilter=!0,this.lastFilterArgs=arguments,this.$div.addClass("fancytree-ext-filter"),hideMode?this.$div.addClass("fancytree-ext-filter-hide"):this.$div.addClass("fancytree-ext-filter-dimm"),this.$div.toggleClass("fancytree-ext-filter-hide-expanders",!!opts.hideExpanders),this.visit((function(node){delete node.match,delete node.titleWithHighlight,node.subMatchCount=0})),(statusNode=this.getRootNode()._findDirectChild(KeyNoData))&&statusNode.remove(),treeOpts.autoCollapse=!1,this.visit((function(node){if(!leavesOnly||null==node.children){var res=filter(node),matchedByBranch=!1;if("skip"===res)return node.visit((function(c){c.match=!1}),!0),"skip";res||!branchMode&&"branch"!==res||!node.parent.match||(res=!0,matchedByBranch=!0),res&&(count++,node.match=!0,node.visitParents((function(p){p.subMatchCount+=1,!opts.autoExpand||matchedByBranch||p.expanded||(p.setExpanded(!0,{noAnimation:!0,noEvents:!0,scrollIntoView:!1}),p._filterAutoExpanded=!0)})))}})),treeOpts.autoCollapse=prevAutoCollapse,0===count&&opts.nodata&&hideMode&&(statusNode=opts.nodata,$.isFunction(statusNode)&&(statusNode=statusNode()),!0===statusNode?statusNode={}:"string"==typeof statusNode&&(statusNode={title:statusNode}),statusNode=$.extend({statusNodeType:"nodata",key:KeyNoData,title:this.options.strings.noData},statusNode),this.getRootNode().addNode(statusNode).match=!0),this.render(),count},$.ui.fancytree._FancytreeClass.prototype.filterNodes=function(filter,opts){return"boolean"==typeof opts&&(opts={leavesOnly:opts},this.warn("Fancytree.filterNodes() leavesOnly option is deprecated since 2.9.0 / 2015-04-19. Use opts.leavesOnly instead.")),this._applyFilterImpl(filter,!1,opts)},$.ui.fancytree._FancytreeClass.prototype.applyFilter=function(filter){return this.warn("Fancytree.applyFilter() is deprecated since 2.1.0 / 2014-05-29. Use .filterNodes() instead."),this.filterNodes.apply(this,arguments)},$.ui.fancytree._FancytreeClass.prototype.filterBranches=function(filter,opts){return this._applyFilterImpl(filter,!0,opts)},$.ui.fancytree._FancytreeClass.prototype.clearFilter=function(){var $title,statusNode=this.getRootNode()._findDirectChild(KeyNoData),escapeTitles=this.options.escapeTitles,enhanceTitle=this.options.enhanceTitle;statusNode&&statusNode.remove(),this.visit((function(node){node.match&&node.span&&($title=$(node.span).find(">span.fancytree-title"),escapeTitles?$title.text(node.title):$title.html(node.title),enhanceTitle&&enhanceTitle({type:"enhanceTitle"},{node:node,$title:$title})),delete node.match,delete node.subMatchCount,delete node.titleWithHighlight,node.$subMatchBadge&&(node.$subMatchBadge.remove(),delete node.$subMatchBadge),node._filterAutoExpanded&&node.expanded&&node.setExpanded(!1,{noAnimation:!0,noEvents:!0,scrollIntoView:!1}),delete node._filterAutoExpanded})),this.enableFilter=!1,this.lastFilterArgs=null,this.$div.removeClass("fancytree-ext-filter fancytree-ext-filter-dimm fancytree-ext-filter-hide"),this.render()},$.ui.fancytree._FancytreeClass.prototype.isFilterActive=function(){return!!this.enableFilter},$.ui.fancytree._FancytreeNodeClass.prototype.isMatched=function(){return!(this.tree.enableFilter&&!this.match)},$.ui.fancytree.registerExtension({name:"filter",version:"@VERSION",options:{autoApply:!0,autoExpand:!1,counter:!0,fuzzy:!1,hideExpandedCounter:!0,hideExpanders:!1,highlight:!0,leavesOnly:!1,nodata:!0,mode:"dimm"},nodeLoadChildren:function(ctx,source){return this._superApply(arguments).done((function(){ctx.tree.enableFilter&&ctx.tree.lastFilterArgs&&ctx.options.filter.autoApply&&ctx.tree._applyFilterImpl.apply(ctx.tree,ctx.tree.lastFilterArgs)}))},nodeSetExpanded:function(ctx,flag,callOpts){return delete ctx.node._filterAutoExpanded,!flag&&ctx.options.filter.hideExpandedCounter&&ctx.node.$subMatchBadge&&ctx.node.$subMatchBadge.show(),this._superApply(arguments)},nodeRenderStatus:function(ctx){var res,node=ctx.node,tree=ctx.tree,opts=ctx.options.filter,$title=$(node.span).find("span.fancytree-title"),$span=$(node[tree.statusClassPropName]),enhanceTitle=ctx.options.enhanceTitle,escapeTitles=ctx.options.escapeTitles;return res=this._super(ctx),$span.length&&tree.enableFilter?($span.toggleClass("fancytree-match",!!node.match).toggleClass("fancytree-submatch",!!node.subMatchCount),1!=node.folder&&$span.toggleClass("fancytree-hide",!(node.match||node.subMatchCount)),!opts.counter||!node.subMatchCount||node.isExpanded()&&opts.hideExpandedCounter?node.$subMatchBadge&&node.$subMatchBadge.hide():(node.$subMatchBadge||(node.$subMatchBadge=$("<span class='fancytree-childcounter'/>")),node.$subMatchBadge.show().text(node.subMatchCount)),!node.span||node.isEditing&&node.isEditing.call(node)||(node.titleWithHighlight?$title.html(node.titleWithHighlight):escapeTitles?$title.text(node.title):$title.html(node.title),enhanceTitle&&enhanceTitle({type:"enhanceTitle"},{node:node,$title:$title})),res):res}}),$.ui.fancytree}));